<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.1.189">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="description" content="Essential tools for modern economic analysis">

<title>R for Economic Research - 1&nbsp; Introduction</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./ds_googlemob.html" rel="next">
<link href="./index.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-6T89HT07F5"></script>

<script type="text/javascript">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-6T89HT07F5', { 'anonymize_ip': true});
</script>

  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

</head>

<body class="nav-sidebar docked">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
    <div class="container-fluid d-flex justify-content-between">
      <h1 class="quarto-secondary-nav-title"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Introduction</span></h1>
      <button type="button" class="quarto-btn-toggle btn" aria-label="Show secondary navigation">
        <i class="bi bi-chevron-right"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse sidebar-navigation docked overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">R for Economic Research</a> 
        <div class="sidebar-tools-main">
    <a href="" title="Download" id="sidebar-tool-dropdown-0" class="sidebar-tool dropdown-toggle px-1" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi bi-download"></i></a>
    <ul class="dropdown-menu" aria-labelledby="sidebar-tool-dropdown-0">
        <li>
          <a class="dropdown-item sidebar-tools-main-item" href="./R-for-Economic-Research.pdf">
            <i class="bi bi-bi-file-pdf pe-1"></i>
          Download PDF
          </a>
        </li>
        <li>
          <a class="dropdown-item sidebar-tools-main-item" href="./R-for-Economic-Research.epub">
            <i class="bi bi-bi-journal pe-1"></i>
          Download ePub
          </a>
        </li>
    </ul>
    <a href="" title="Share" id="sidebar-tool-dropdown-1" class="sidebar-tool dropdown-toggle px-1" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi bi-share"></i></a>
    <ul class="dropdown-menu" aria-labelledby="sidebar-tool-dropdown-1">
        <li>
          <a class="dropdown-item sidebar-tools-main-item" href="https://twitter.com/intent/tweet?url=|url|">
            <i class="bi bi-bi-twitter pe-1"></i>
          Twitter
          </a>
        </li>
        <li>
          <a class="dropdown-item sidebar-tools-main-item" href="https://www.facebook.com/sharer/sharer.php?u=|url|">
            <i class="bi bi-bi-facebook pe-1"></i>
          Facebook
          </a>
        </li>
    </ul>
</div>
    </div>
      </div>
      <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
      </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">Preface</a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">Data science with Tidyverse</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./ds_tidyverse.html" class="sidebar-item-text sidebar-link active"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Introduction</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./ds_googlemob.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Scaling-up tasks</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">Basic time series tools</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./ds_seasonality.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Seasonal adjustment</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./ds_nominal2real.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Deflating nominal values to real values</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./ds_hpfilter.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Hodrick-Prescott Filter</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true">Forecasting</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./fc_abc.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">The ABC</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./fc_comparison.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Forecasting by comparison</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./fc_simulation.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Simulations</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true">State-space models</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./ss_intro.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Introduction</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./ss_tv_coef.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Time-varying regression coefficient</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./ss_common.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Dynamic Factor Model</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" aria-expanded="true">Economic modelling</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./single_equation.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Single equation models</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./multiple_equations.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Multiple equations model</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">References</a>
  </div>
</li>
    </ul>
    </div>
</nav>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#whats-tidyverse" id="toc-whats-tidyverse" class="nav-link active" data-scroll-target="#whats-tidyverse"><span class="toc-section-number">1.1</span>  What’s tidyverse?</a></li>
  <li><a href="#import" id="toc-import" class="nav-link" data-scroll-target="#import"><span class="toc-section-number">1.2</span>  Importing</a>
  <ul class="collapse">
  <li><a href="#reading-from-flat-files" id="toc-reading-from-flat-files" class="nav-link" data-scroll-target="#reading-from-flat-files"><span class="toc-section-number">1.2.1</span>  Reading from flat files</a></li>
  <li><a href="#readapi" id="toc-readapi" class="nav-link" data-scroll-target="#readapi"><span class="toc-section-number">1.2.2</span>  Reading from API</a></li>
  </ul></li>
  <li><a href="#wrangling" id="toc-wrangling" class="nav-link" data-scroll-target="#wrangling"><span class="toc-section-number">1.3</span>  Wrangling</a>
  <ul class="collapse">
  <li><a href="#data-manipulation" id="toc-data-manipulation" class="nav-link" data-scroll-target="#data-manipulation"><span class="toc-section-number">1.3.1</span>  Data manipulation</a></li>
  <li><a href="#datalay" id="toc-datalay" class="nav-link" data-scroll-target="#datalay"><span class="toc-section-number">1.3.2</span>  Data layout</a></li>
  <li><a href="#text-manipulation" id="toc-text-manipulation" class="nav-link" data-scroll-target="#text-manipulation"><span class="toc-section-number">1.3.3</span>  Text manipulation</a></li>
  <li><a href="#date-manipulation" id="toc-date-manipulation" class="nav-link" data-scroll-target="#date-manipulation"><span class="toc-section-number">1.3.4</span>  Date manipulation</a></li>
  </ul></li>
  <li><a href="#looping" id="toc-looping" class="nav-link" data-scroll-target="#looping"><span class="toc-section-number">1.4</span>  Looping</a></li>
  <li><a href="#plotting" id="toc-plotting" class="nav-link" data-scroll-target="#plotting"><span class="toc-section-number">1.5</span>  Plotting</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title"><span id="ds_intro" class="quarto-section-identifier d-none d-lg-block"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Introduction</span></span></h1>
</div>

<div>
  <div class="description">
    Essential tools for modern economic analysis
  </div>
</div>


<div class="quarto-title-meta">

    
    
  </div>
  

</header>

<p>The purpose of this chapter is to introduce the main functions of the core packages in tidyverse. It’s not intended to be a thorough description of every function, rather the idea is to provide the basic tools so that those who are either base R users or aren’t R users at all can follow along with the rest of the book. For a more detailed approach to tidyverse, the best source is undoubtedly the great <span class="citation" data-cites="r4ds">Grolemund and Wickham (<a href="#ref-r4ds" role="doc-biblioref">2017</a>)</span>. For those who feel comfortable with tidyverse, a quick skim through the chapter might be enough.</p>
<section id="whats-tidyverse" class="level2" data-number="1.1">
<h2 data-number="1.1" class="anchored" data-anchor-id="whats-tidyverse"><span class="header-section-number">1.1</span> What’s tidyverse?</h2>
<p>To start, what’s tidyverse? According to the <a href="https://www.tidyverse.org/">official website</a>:</p>
<blockquote class="blockquote">
<p>The tidyverse is an opinionated collection of R packages designed for data science. All packages share an underlying design philosophy, grammar, and data structures.</p>
</blockquote>
<p>From my own experience I can ensure you that tidyverse is all you need to carry out data analyses as <strong>neat</strong> and <strong>flexible</strong> as possible. By <strong>neat</strong> I mean succinct code without any redundancy, i.e, a single block of code (not a bunch of loose objects) doing all the desired task. <strong>Flexible</strong>, in turn, means the code is general enough. It depends on the nature of the task at hand, so take it more like a philosophy. For example, does the solution still work if the data is updated with new values? Or does it depend on changeable references such as column positions?</p>
<p>Most of the time writing neat and flexible code takes longer and requires a dose of creativity, but it surely pays off. Moreover, with practice this will become more and more natural and the cost will get significantly lower. In the next sections we’ll review the most used functions to go through all the steps of everyday data analyses using core tidyverse packages designed to <strong>Import</strong>, <strong>Wrangle</strong>, <strong>Program</strong> and <strong>Plot</strong>.</p>
</section>
<section id="import" class="level2" data-number="1.2">
<h2 data-number="1.2" class="anchored" data-anchor-id="import"><span class="header-section-number">1.2</span> Importing</h2>
<section id="reading-from-flat-files" class="level3" data-number="1.2.1">
<h3 data-number="1.2.1" class="anchored" data-anchor-id="reading-from-flat-files"><span class="header-section-number">1.2.1</span> Reading from flat files</h3>
<p><code>readr</code> is the tidyverse’s package used to import data from flat files (basically .csv and .txt files). The most generic function is <code>read_delim</code> as it has a large set of parameters that allow us to declare the structure of the data we want to import. In practice, we often use the <code>read_csv</code> which is a special case of the former with some predefined settings suitable for .csv files – the most obvious being the comma as the column delimiter.</p>
<p>If you’re running RStudio IDE, I recommend you to click on <strong>Import Dataset</strong> at the <strong>Environment</strong> sheet (by default it’s located on the upper right panel) to manually define the appropriate settings for your file. <strong>I know we should never be encouraged to use windows, click on buttons or any kind of shortcuts provided by the IDE. This is the only exception I think is worth it</strong>. First, because it can be tedious to set many specific parameters via trial-and-error to correctly import your data. Second, because once you have the configuration done the code is displayed at the bottom of the window so you can copy it and paste it on your script and, eventually, get rid of this shortcut as you learn how things work. Lastly, you probably won’t repeat this action many times when working on a given task and there’s not much to improve on this process. Then, Yes, it’s a big waste of time trying to understand each single parameter.</p>
<p>Just for the sake of illustration, let’s use <code>readr</code> to import the COVID data set from Our World in Data. It’s a standard .csv file, so we can use <code>read_csv</code> without any additional parameter. We just need to provide the file path:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>data_path  <span class="ot">&lt;-</span> <span class="st">'data/owid-covid-data.csv'</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>covid_data <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(data_path)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>or the URL:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>data_url   <span class="ot">&lt;-</span> <span class="st">'https://raw.githubusercontent.com/owid/covid-19-data/master/public/data/owid-covid-data.csv'</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>covid_data <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(data_url)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Tidyverse also provides packages for reading other usual file types. For instance, we can use <code>readxl</code> to read MS Excel spreadsheets and <code>haven</code> to read data generated by popular statistical softwares (SPSS, Stata and SAS) in much the same way we did with <code>readr</code> for .csv files (you can check them at the <strong>Import Dataset</strong> dropdown menu) so we won’t cover them. Rather, let’s use the rest of this section to talk about something very important and that usually gets less attention in books: reading data from an API.</p>
</section>
<section id="readapi" class="level3" data-number="1.2.2">
<h3 data-number="1.2.2" class="anchored" data-anchor-id="readapi"><span class="header-section-number">1.2.2</span> Reading from API</h3>
<p>Although the use of traditional flat files are still widespread, organizations are increasingly switching to API’s to make data available to the public. This is a huge improvement since we’re able to customize our demand and import only the data we need for the specific task.</p>
<p>If you don’t know what an API is, think of it as an interface to a database. However, instead of reading all the content from this database you can inform what columns you want, the desired observations (time range if it’s a time series) and so on. These filters are embedded in a <strong>request</strong> and the right form to specify it is usually available in a documentation provided by the API maintainer.</p>
<p>For example, the Federal Reserve Bank of St.&nbsp;Louis maintains a huge repository with hundreds of thousands of economic time series and we can import them using an API. The information on how to build the request is available in the <a href="https://fred.stlouisfed.org/docs/api/fred/">documentation</a>, where we can see a link with instructions on how to <strong>‘Get the observations or data values for an economic data series’</strong>. There, we find an example of a request for the US Real Gross National Product:</p>
<p><a href="https://api.stlouisfed.org/fred/series/observations?series_id=GNPCA&amp;api_key=abcdefghijklmnopqrstuvwxyz123456&amp;file_type=json" class="uri">https://api.stlouisfed.org/fred/series/observations?series_id=GNPCA&amp;api_key=abcdefghijklmnopqrstuvwxyz123456&amp;file_type=json</a></p>
<p>We can break this request down to see its parts in more detail:</p>
<ol type="1">
<li>The main (static) URL to access the <strong>Observations</strong> section:</li>
</ol>
<p><span class="math display">\[
\underbrace{\text{https://api.stlouisfed.org/fred/series/observations?}}_\text{Static: API URL}
\]</span></p>
<ol start="2" type="1">
<li>The series ID which identifies the US Real Gross National Product data.</li>
</ol>
<p><span class="math display">\[
\underbrace{\text{series\_id=GNPCA}}_\text{Parameter: Series ID}
\]</span></p>
<ol start="3" type="1">
<li>The API Key. We must create an account and require a personal key in order to import data from the API. This one is an example for illustrative purposes only.</li>
</ol>
<p><span class="math display">\[
\underbrace{\text{api\_key=abcdefghijklmnopqrstuvwxyz123456}}_\text{Parameter: API Key}
\]</span></p>
<ol start="4" type="1">
<li>The file type for the output. There are several types, but I’d rather working with JSON.</li>
</ol>
<p><span class="math display">\[
\underbrace{\text{file\_type=json}}_\text{Parameter: File Type}
\]</span></p>
<p>Note that all the parameters following the static part are separated by an <strong>&amp;</strong>. Then, if we want to add any extra parameter it should be placed right after this character. Also, the order of the parameters is not relevant.</p>
<p>Suppose we want to read monthly data for the <a href="https://fred.stlouisfed.org/series/CPALTT01USM657N">US Consumer Price Index (CPI)</a>. The <code>series_id</code> is <strong>CPALTT01USM657N</strong>. Besides, we’d only like to read data between January 2010 and December 2022. How can we do so? There are two parameters – <code>observation_start</code> and <code>observation_end</code> which set, respectively, the range of the observation period (YYYY-MM-DD format).</p>
<p>The code below creates a separate object for each part of the request. Then, we use the <code>glue</code> function from the homonymous package to merge the pieces into a single string adding the <strong>&amp;</strong> character between parameters. We could create the full string all at once, but creating separate objects makes it easier to find and edit values as well as to transform this task into a custom function if we had to frequently read data from this source (more on this later).</p>
<p>You’ll need to register in order to be granted access to the API. Since this information is personal, I stored my key as an environmental variable named <code>api_fred_key</code> which can be accessed like any other object.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(glue)</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>api_url       <span class="ot">&lt;-</span> <span class="st">'https://api.stlouisfed.org/fred/series/observations?'</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>api_fred_key  <span class="ot">&lt;-</span> <span class="fu">Sys.getenv</span>(<span class="st">'api_fred_key'</span>)</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>api_series_id <span class="ot">&lt;-</span> <span class="st">'CPALTT01USM657N'</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>obs_start     <span class="ot">&lt;-</span> <span class="st">'2010-01-01'</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>obs_end       <span class="ot">&lt;-</span> <span class="st">'2022-12-01'</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>api_filetype  <span class="ot">&lt;-</span> <span class="st">'json'</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>api_request   <span class="ot">&lt;-</span> <span class="fu">glue</span>(<span class="st">'{api_url}series_id={api_series_id}&amp;observation_start={obs_start}&amp;observation_end={obs_end}&amp;api_key={api_fred_key}&amp;file_type={api_filetype}'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now we use the <code>httr</code> package to connect to the API, send the request and get the content. The other steps transform the content from JSON to a standard R object (a list) and then convert it to a tibble (the tidyverse’s improved format for data frames). Notice that the CPI data is stored in the list element named <code>observations</code>. However, this is specific for this API and if we were to import data from another source we’d have to check in which element the data would be stored.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(httr)</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(jsonlite)</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>cpi_request <span class="ot">&lt;-</span> <span class="fu">GET</span>(<span class="at">url =</span> api_request)</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>cpi_content <span class="ot">&lt;-</span> <span class="fu">content</span>(cpi_request, <span class="at">as =</span> <span class="st">'text'</span>)</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>cpi_list    <span class="ot">&lt;-</span> <span class="fu">fromJSON</span>(cpi_content, <span class="at">flatten =</span> <span class="cn">FALSE</span>)</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>cpi_tbl     <span class="ot">&lt;-</span> cpi_list[[<span class="st">'observations'</span>]] <span class="sc">%&gt;%</span> <span class="fu">as_tibble</span>()</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>cpi_tbl</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 156 x 4
   realtime_start realtime_end date       value              
   &lt;chr&gt;          &lt;chr&gt;        &lt;chr&gt;      &lt;chr&gt;              
 1 2023-04-11     2023-04-11   2010-01-01 0.34174735701485   
 2 2023-04-11     2023-04-11   2010-02-01 0.024920738207648  
 3 2023-04-11     2023-04-11   2010-03-01 0.410628353657108  
 4 2023-04-11     2023-04-11   2010-04-01 0.173688491069743  
 5 2023-04-11     2023-04-11   2010-05-01 0.0775197354237721 
 6 2023-04-11     2023-04-11   2010-06-01 -0.0976267084673888
 7 2023-04-11     2023-04-11   2010-07-01 0.0211043057371509 
 8 2023-04-11     2023-04-11   2010-08-01 0.138066427840807  
 9 2023-04-11     2023-04-11   2010-09-01 0.0581736230715569 
10 2023-04-11     2023-04-11   2010-10-01 0.124519888847696  
# ... with 146 more rows</code></pre>
</div>
</div>
<p>This concludes our section on how to import data. If you’re struggling with other types of data, Tidyverse’s official <a href="https://www.tidyverse.org/packages/#import">website</a> provides a comprehensive list of all the supported file formats and the respective packages used to handle them. Also, you can take a look at the <code>rio</code> package, which makes it easy to import and export data from and to different file extensions.</p>
</section>
</section>
<section id="wrangling" class="level2" data-number="1.3">
<h2 data-number="1.3" class="anchored" data-anchor-id="wrangling"><span class="header-section-number">1.3</span> Wrangling</h2>
<p>This is by far the most important section in this Chapter. The main goal here is to provide a general sense of how to get raw data ready to use. For this, we’ll focus on the roles of the main functions from <code>dplyr</code> package rather than the idiosyncrasies and generalizations of each one. More sophisticated applications will be shown in the next chapters.</p>
<section id="data-manipulation" class="level3" data-number="1.3.1">
<h3 data-number="1.3.1" class="anchored" data-anchor-id="data-manipulation"><span class="header-section-number">1.3.1</span> Data manipulation</h3>
<p>Let’s use the COVID data we imported in the last section. Starting with the <code>glimpse</code> function to have a grasp of the data, we can see some useful information such as the number of rows and columns, as well as columns’ names and classes (whether they’re character, double, etc).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>covid_data <span class="sc">%&gt;%</span> </span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">glimpse</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We’re usually not interested in all of these data, so the first couple of tasks we’d like to perform is to filter the relevant categories and select the desired columns. For example, we could be interested in analyzing new COVID cases (column <code>new_cases</code>) only in Brazil (rows equal to <code>Brazil</code> in column <code>location</code>). Furthermore, we’d like to get rid of duplicate rows if there’s any.</p>
<p>One of the great contributions of tidyverse is to assign names (verbs) to the functions according to the actions they perform – many are admittedly SQL-inspired. For example, <code>distinct</code> drops observations (rows) which are not unique, whereas <code>select</code> picks variables based on their names (or positions). The exception is <code>filter</code>, which retains the rows which satisfy a given condition (the analogue of WHERE in SQL).</p>
<p>Conditions are sentences which returns <code>TRUE</code> or <code>FALSE</code>. It’s straightforward to think of conditions using logical operators, such as <code>==</code>, <code>&gt;</code>, <code>&lt;</code>, etc. Nevertheless, there’s a bunch of expressions in R which return <code>TRUE</code> or <code>FALSE</code>. Moreover, we can always create our own condition to generate the desired output. We’ll see many examples throughout this book.</p>
<p>The code below performs the initial steps described above to generate a subset of the data.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>covid_data_sub1 <span class="ot">&lt;-</span> covid_data <span class="sc">%&gt;%</span> </span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(date, continent, location, new_cases) <span class="sc">%&gt;%</span> </span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(location <span class="sc">==</span> <span class="st">'Brazil'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Next, we may need to create additional columns. For instance, suppose that actual new cases in Brazil are much higher than reported because the country doesn’t have enough tests and a conservative estimate points to a number of, say, twice the official count. So we’d like to add a column which is twice the value of the original one representing our guess of the real situation. In addition, we’d also like to create a column to indicate the dominant strain at each period of time. We know that the Delta strain took over Gamma by the end of July 2021 and, then, Omicron took over Delta in the beginning of 2022.</p>
<p>The <code>mutate</code> verb can be used to create new variables as a function of existing ones. Also, it can be used to modify existing variables as new variables overwrites those with the same name. <code>case_when</code> is another SQL-inspired function used inside <code>mutate</code> to create a new variable based on conditions. It’s worth noting that it returns <code>NA</code> if no condition is met. In this case, a useful workaround is to define an extra condition as <code>TRUE ~ value</code>, thus assigning a value to all the unmet conditions – think of this as an <strong>else</strong> statement.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>covid_data_sub2 <span class="ot">&lt;-</span> covid_data_sub1 <span class="sc">%&gt;%</span> </span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">real_new_cases =</span> <span class="dv">2</span><span class="sc">*</span>new_cases,</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">dominant_strain  =</span> <span class="fu">case_when</span>(</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>      date <span class="sc">&lt;=</span> <span class="st">'2021-07-31'</span>                        <span class="sc">~</span> <span class="st">'Gamma'</span>,</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>      date <span class="sc">&gt;</span>  <span class="st">'2021-07-31'</span> <span class="sc">&amp;</span> date <span class="sc">&lt;=</span> <span class="st">'2021-12-31'</span> <span class="sc">~</span> <span class="st">'Delta'</span>,</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>      date <span class="sc">&gt;</span>  <span class="st">'2021-12-31'</span> <span class="sc">&amp;</span> date <span class="sc">&lt;=</span> <span class="st">'2022-02-01'</span> <span class="sc">~</span> <span class="st">'Omicron'</span>,</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>      <span class="cn">TRUE</span>                                        <span class="sc">~</span> <span class="st">"We don't know"</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The <code>between</code> function is a shortcut for numeric conditions that are bounded both on the left and on the right. It also works with dates if we declare the arguments as date objects. Therefore, we can replace conditions 2 and 3 in order to have a more compact and efficient code (it’s implemented in C++, like many modern R functions).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>covid_data_sub2 <span class="ot">&lt;-</span> covid_data_sub1 <span class="sc">%&gt;%</span> </span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">real_new_cases =</span> <span class="dv">2</span><span class="sc">*</span>new_cases,</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">dominant_strain  =</span> <span class="fu">case_when</span>(</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>      date <span class="sc">&lt;=</span> <span class="st">'2021-07-31'</span>                                          <span class="sc">~</span> <span class="st">'Gamma'</span>,</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>      <span class="fu">between</span>(date, <span class="fu">as.Date</span>(<span class="st">'2021-07-31'</span>), <span class="fu">as.Date</span>(<span class="st">'2021-12-31'</span>))   <span class="sc">~</span> <span class="st">'Delta'</span>,</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>      <span class="fu">between</span>(date, <span class="fu">as.Date</span>(<span class="st">'2021-12-31'</span>), <span class="fu">as.Date</span>(<span class="st">'2022-02-01'</span>))   <span class="sc">~</span> <span class="st">'Omicron'</span>,</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>      <span class="cn">TRUE</span>                                                          <span class="sc">~</span> <span class="st">"We don't know"</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>So far we’ve worked on a single group of data: new cases in Brazil. However, we usually have many categories to work on. We might be interested in analyzing new cases in all European countries, for example. In this case, we’ll need the <code>group_by</code> function, which allows us to perform operations by group. <code>group_by</code> is often used in conjunction with <code>mutate</code> or <code>summarise</code> to create new data for each group. The latter uses aggregate functions (<code>mean</code>, <code>max</code>, <code>min</code>, etc) to produce a summary of the data.</p>
<p>For example, suppose we want to know which European country recorded the highest number of new covid cases in a single day by the mid of 2022. This might be achieved by grouping the data by location and then using <code>summarise</code> with <code>max</code>. In addition, we can use <code>arrange</code> to sort the rows by value (we use <code>desc</code> to sort in descending order). Don’t forget to <code>ungroup</code> data as soon as you no longer need to perform grouped operations.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>covid_data_sub3 <span class="ot">&lt;-</span> covid_data <span class="sc">%&gt;%</span> </span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>    continent <span class="sc">==</span> <span class="st">'Europe'</span>,</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>    date <span class="sc">&lt;=</span> <span class="st">'2021-06-30'</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(location) <span class="sc">%&gt;%</span> </span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">max_new_cases =</span> <span class="fu">max</span>(new_cases)) <span class="sc">%&gt;%</span> </span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(max_new_cases))</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>covid_data_sub3</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 51 x 2
   location       max_new_cases
   &lt;chr&gt;                  &lt;dbl&gt;
 1 United Kingdom         68066
 2 Germany                45333
 3 Italy                  40902
 4 Poland                 35253
 5 Sweden                 32485
 6 Russia                 29499
 7 Belgium                23921
 8 Switzerland            21926
 9 Ukraine                20456
10 Netherlands            13037
# ... with 41 more rows</code></pre>
</div>
</div>
<p>Note that some countries such as Spain, Portugal and France returned <code>NA</code>. This happened because they probably have any missing value. We could easily ignore it by passing the argument <code>na.rm = TRUE</code> to the <code>max</code> function. However, another problem would arise: countries with no data on new cases would return <code>-Inf</code>. To get around these two issues, we can filter all the missing values out in the data set using the logical operator <code>is.na()</code> (the <code>!</code> before the condition works as a negation). In this case removing the missing values isn’t a problem, but be aware that for some tasks this may influence the outcome.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>covid_data_sub4 <span class="ot">&lt;-</span> covid_data <span class="sc">%&gt;%</span> </span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>    continent <span class="sc">==</span> <span class="st">'Europe'</span>,</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>    date <span class="sc">&lt;=</span> <span class="st">'2022-06-30'</span>,</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>    <span class="sc">!</span><span class="fu">is.na</span>(new_cases)</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(location) <span class="sc">%&gt;%</span> </span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">max_new_cases =</span> <span class="fu">max</span>(new_cases)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(max_new_cases))</span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>covid_data_sub4</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 49 x 2
   location       max_new_cases
   &lt;chr&gt;                  &lt;dbl&gt;
 1 France                117900
 2 Germany               103018
 3 Spain                  93822
 4 United Kingdom         92713
 5 Belgium                47836
 6 Italy                  40902
 7 Russia                 40210
 8 Poland                 35253
 9 Sweden                 32485
10 Ukraine                28477
# ... with 39 more rows</code></pre>
</div>
</div>
<p>In addition, we might want to know not only what the highest numbers were but when they did occur (the peak date). Since the <code>summarise</code> function is designed to return a single value, we must use an expression which returns a single value. If we used <code>date = max(date)</code>, we’d keep the most recent date for the data in each country. Definitely, that’s not what we want. So a good way to address this issue is to combine a subset operation with a condition inside. In simpler terms, we’ll subset from the column date the observation where new cases were at its high. Since we can have multiple dates which satisfy this condition, we’ll keep the most recent one (the <code>max</code> of them).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>covid_data_sub5 <span class="ot">&lt;-</span> covid_data <span class="sc">%&gt;%</span> </span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>    continent <span class="sc">==</span> <span class="st">'Europe'</span>,</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>    date <span class="sc">&lt;=</span> <span class="st">'2022-06-30'</span>,</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>    <span class="sc">!</span><span class="fu">is.na</span>(new_cases)</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(location) <span class="sc">%&gt;%</span> </span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">max_new_cases =</span> <span class="fu">max</span>(new_cases),</span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">peak_date =</span> date[<span class="fu">which</span>(new_cases <span class="sc">==</span> max_new_cases)] <span class="sc">%&gt;%</span> <span class="fu">max</span>()</span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(max_new_cases), peak_date) <span class="sc">%&gt;%</span> </span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>)</span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>covid_data_sub5</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 10 x 3
   location       max_new_cases peak_date 
   &lt;chr&gt;                  &lt;dbl&gt; &lt;date&gt;    
 1 France                117900 2021-04-11
 2 Germany               103018 2021-12-09
 3 Spain                  93822 2021-01-25
 4 United Kingdom         92713 2021-12-17
 5 Belgium                47836 2021-11-29
 6 Italy                  40902 2020-11-13
 7 Russia                 40210 2021-11-06
 8 Poland                 35253 2021-04-01
 9 Sweden                 32485 2020-12-29
10 Ukraine                28477 2021-11-04</code></pre>
</div>
</div>
<p>In case it went unnoticed, the previous code showed a really nice feature of <code>mutate</code>/<code>summarise</code>: you can use a variable you’ve just created in a subsequent task inside the same calling. In this example we used <code>max_new_cases</code> as an input in <code>peak_date</code>, all of this inside the same <code>summarise</code> calling as if all steps were performed sequentially.</p>
<p>In the last two lines, we used <code>arrange</code> to sort countries firstly by the maximum number of new cases and then by their peak date and <code>slice</code> to subset only the first ten countries out of the forty-nine in our data set. This ends our approach to single data sets for now.</p>
<p>But before we jump to the next section, there’s something very important to address: merging multiple data sets. There are two families of functions in <code>dplyr</code> to merge data frames, <code>*_join</code> and <code>bind_*</code>. Let’s see how they work.</p>
<p>The <code>*_join</code> functions are used to merge two data frames horizontally, matching their rows based on specified keys. For example, take the <code>covid_data_sub5</code> data frame we created above. It contains the top ten European countries with the highest number of new Covid cases in a single day and their peak dates. Suppose we want to add information on the population size for each country, which is available in another data frame named <code>europe_population</code> displayed below.<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a></p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 51 x 2
   Country         Pop_size
   &lt;chr&gt;              &lt;dbl&gt;
 1 Russia         145912022
 2 Germany         83900471
 3 United Kingdom  68207114
 4 France          67564251
 5 Italy           60367471
 6 Spain           46745211
 7 Ukraine         43466822
 8 Poland          37797000
 9 Romania         19127772
10 Netherlands     17173094
# ... with 41 more rows</code></pre>
</div>
</div>
<p>What we want here is to add the column <em>Pop_Size</em> from <code>europe_population</code> into <code>covid_data_sub5</code> matching rows based on <code>location</code> (the column with countries in the main data set). For this, we can use the <code>left_join</code> function, which adds the content from the second data frame to the first one. The <code>by</code> argument is needed because the name of the key column differs across the two data sets.<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>covid_data_sub5_with_pop <span class="ot">&lt;-</span> covid_data_sub5 <span class="sc">%&gt;%</span> </span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(europe_population, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">'location'</span> <span class="ot">=</span> <span class="st">'Country'</span>))</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>covid_data_sub5_with_pop</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 10 x 4
   location       max_new_cases peak_date   Pop_size
   &lt;chr&gt;                  &lt;dbl&gt; &lt;date&gt;         &lt;dbl&gt;
 1 France                117900 2021-04-11  67564251
 2 Germany               103018 2021-12-09  83900471
 3 Spain                  93822 2021-01-25  46745211
 4 United Kingdom         92713 2021-12-17  68207114
 5 Belgium                47836 2021-11-29  11632334
 6 Italy                  40902 2020-11-13  60367471
 7 Russia                 40210 2021-11-06 145912022
 8 Poland                 35253 2021-04-01  37797000
 9 Sweden                 32485 2020-12-29  10160159
10 Ukraine                28477 2021-11-04  43466822</code></pre>
</div>
</div>
<p>We could have been assigned a slightly different task. For example, adding to <code>european_population</code> the information on maximum daily number of new Covid cases and peak dates we have from <code>covid_data_sub5</code>. This can also be achieved with <code>left_join</code> by reversing the order of the data frames (and names of the key column since they’re not the same). An effortless alternative is to replace <code>left_join</code> with <code>right_join</code>, which adds to the second data frame (the one on the right) the information from the first data frame (the one on the left). In this case we don’t need to change the order of the parameters.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>pop_with_covid_info <span class="ot">&lt;-</span> covid_data_sub5 <span class="sc">%&gt;%</span> </span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">right_join</span>(europe_population, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">'location'</span> <span class="ot">=</span> <span class="st">'Country'</span>))</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>pop_with_covid_info</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 51 x 4
   location       max_new_cases peak_date   Pop_size
   &lt;chr&gt;                  &lt;dbl&gt; &lt;date&gt;         &lt;dbl&gt;
 1 France                117900 2021-04-11  67564251
 2 Germany               103018 2021-12-09  83900471
 3 Spain                  93822 2021-01-25  46745211
 4 United Kingdom         92713 2021-12-17  68207114
 5 Belgium                47836 2021-11-29  11632334
 6 Italy                  40902 2020-11-13  60367471
 7 Russia                 40210 2021-11-06 145912022
 8 Poland                 35253 2021-04-01  37797000
 9 Sweden                 32485 2020-12-29  10160159
10 Ukraine                28477 2021-11-04  43466822
# ... with 41 more rows</code></pre>
</div>
</div>
<p>At first glance it seems to produce the same outcome, but notice that the number of rows are different in the two resulting data sets. In the first case <code>left_join</code> kept all the rows from <code>covid_data_sub5</code> and only the <em>corresponding</em> rows from <code>europe_population</code>, whereas <code>right_join</code> did the opposite. In summary, <code>left_join</code> and <code>right_join</code> keep all the rows from just one of the two data frames.</p>
<p>Sometimes, however, we want to keep all the rows from both data frames. For example, imagine that <code>covid_data_sub5</code> had data not only on European but on South American countries as well. In addition, the <code>european_population</code> data frame also included the populations from Asian countries. If we merged the data frames using the functions above, we’d end up loosing observations on either Covid in South America or populations in Asia.</p>
<p>In order to merge the data frames by their common countries while keeping the remaining observations from both, we should employ the <code>full_join</code> function. On the other hand, if we’re willing to keep only the common countries in both data frames, this is the case for the <code>inner_join</code> function.</p>
<p>These four functions comprise what it’s called <strong>mutating-joins</strong> since they add columns from one data frame to the other. There are also the <strong>filtering-joins</strong> functions, which filter the rows from one data frame based on the presence (<code>semi_join</code>) or absence (<code>anti_join</code>) of matches in the other data frame. Given the latter category is used to a much lesser extent, I won’t go into detail right now. Eventually they’ll show up in the coming chapters.</p>
<p>We saw that <code>*_join*</code> operations are particularly useful to merge data frames horizontally and by their matching rows according to key variables. More often than not we need to stack data vertically by their matching columns. For example, suppose the Covid data set was released as a single file for each country and we needed to perform some comparisons between France and the United Kingdom - <code>covid_fr</code> and <code>covid_uk</code> data sets shown below.</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 690 x 3
   date       location       new_cases
   &lt;date&gt;     &lt;chr&gt;              &lt;dbl&gt;
 1 2020-01-31 United Kingdom         2
 2 2020-02-01 United Kingdom         0
 3 2020-02-02 United Kingdom         0
 4 2020-02-03 United Kingdom         6
 5 2020-02-04 United Kingdom         0
 6 2020-02-05 United Kingdom         1
 7 2020-02-06 United Kingdom         0
 8 2020-02-07 United Kingdom         0
 9 2020-02-08 United Kingdom         4
10 2020-02-09 United Kingdom         1
# ... with 680 more rows</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 697 x 4
   date       location new_cases total_cases
   &lt;date&gt;     &lt;chr&gt;        &lt;dbl&gt;       &lt;dbl&gt;
 1 2020-01-24 France           2           2
 2 2020-01-25 France           1           3
 3 2020-01-26 France           0           3
 4 2020-01-27 France           0           3
 5 2020-01-28 France           1           4
 6 2020-01-29 France           1           5
 7 2020-01-30 France           0           5
 8 2020-01-31 France           0           5
 9 2020-02-01 France           1           6
10 2020-02-02 France           0           6
# ... with 687 more rows</code></pre>
</div>
</div>
<p>This can be easily accomplished by <code>bind_rows</code> which, unlike the <code>*_join</code> family, allows us to provide several data frames. What’s cool about <code>bind_rows</code> is that non-matching columns are kept with their values filled with <code>NA</code> for the data frames where the column is absent. In the example above, the <code>covid_fr</code> data set has a total cases column which is absent in <code>covid_uk</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>covid_fr_uk <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(covid_fr, covid_uk)</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>covid_fr_uk</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1,387 x 4
   date       location new_cases total_cases
   &lt;date&gt;     &lt;chr&gt;        &lt;dbl&gt;       &lt;dbl&gt;
 1 2020-01-24 France           2           2
 2 2020-01-25 France           1           3
 3 2020-01-26 France           0           3
 4 2020-01-27 France           0           3
 5 2020-01-28 France           1           4
 6 2020-01-29 France           1           5
 7 2020-01-30 France           0           5
 8 2020-01-31 France           0           5
 9 2020-02-01 France           1           6
10 2020-02-02 France           0           6
# ... with 1,377 more rows</code></pre>
</div>
</div>
<p>The <code>bind_cols</code> function is more restrictive in this regard. It’s used to merge the columns of data frames, but matching by row position rather than a key variable. For this reason, we can’t have data frames of different lengths. In practice, it’s much more common to rely on <code>*_join*</code> functions when we need to merge data frames horizontally.</p>
</section>
<section id="datalay" class="level3" data-number="1.3.2">
<h3 data-number="1.3.2" class="anchored" data-anchor-id="datalay"><span class="header-section-number">1.3.2</span> Data layout</h3>
<p>We’ve walked through the main functions of <code>dplyr</code>. Now, we turn to the <code>tidyr</code> package. According to the tidyverse’s website, the goal of <code>tidyr</code> is to help us create <strong>tidy data</strong>. It means a data set where every column is a variable; every row is an observation; and each cell is a single value.</p>
<p>Tidy data is also known as <strong>wide</strong> format – since it increases the number of columns and decreases the number of rows –, as opposed to the <strong>long</strong> format, where data are stacked increasing the number of rows and decreasing the number of columns. It took me a while before I could tell if a data set was either in wide or long format, so don’t worry if it’s not so clear right now. Perhaps a more direct way of thinking about this distinction is to ask yourself: <em>Is all the information contained in a single cell?</em>. If so, it’s wide format. If not, then it’s long format.</p>
<p>For example, is the Covid data set in wide or long format? If we took a single cell from the <strong>new_cases</strong> column, does it convey all the information for this variable contained in the data set? No, it doesn’t. We know the number of new cases in a given date, but we don’t know the country that value refers to – is this from Germany? Nigeria? Chile?</p>
<p>We can use the <code>pivot_wider</code> function from <code>tidyr</code> package to convert from long to wide format. The syntax is very easy to understand: <code>names_from</code> is the column we want to widen, whereas <code>values_from</code> is the column containing the observations that will fill each cell. <code>id_cols</code> is a parameter used to declare the set of columns that uniquely identifies each observation. In practice, it drops all the other columns in the data set. Hence, if we want to keep all the other variables, just skip it.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>covid_wide_01 <span class="ot">&lt;-</span> covid_data <span class="sc">%&gt;%</span> </span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">id_cols     =</span> <span class="st">'date'</span>, </span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_from  =</span> <span class="st">'location'</span>, </span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_from =</span> <span class="st">'new_cases'</span></span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>covid_wide_01</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 720 x 226
   date       Afghanistan Albania Algeria Andorra Angola Anguilla
   &lt;date&gt;           &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt;    &lt;dbl&gt;
 1 2020-02-24           5      NA      NA      NA     NA       NA
 2 2020-02-25           0      NA       1      NA     NA       NA
 3 2020-02-26           0      NA       0      NA     NA       NA
 4 2020-02-27           0      NA       0      NA     NA       NA
 5 2020-02-28           0      NA       0      NA     NA       NA
 6 2020-02-29           0      NA       0      NA     NA       NA
 7 2020-03-01           0      NA       0      NA     NA       NA
 8 2020-03-02           0      NA       2       1     NA       NA
 9 2020-03-03           0      NA       2       0     NA       NA
10 2020-03-04           0      NA       7       0     NA       NA
# ... with 710 more rows, and 219 more variables: `Antigua and Barbuda` &lt;dbl&gt;,
#   Argentina &lt;dbl&gt;, Armenia &lt;dbl&gt;, Aruba &lt;dbl&gt;, Australia &lt;dbl&gt;,
#   Austria &lt;dbl&gt;, Azerbaijan &lt;dbl&gt;, Bahamas &lt;dbl&gt;, Bahrain &lt;dbl&gt;,
#   Bangladesh &lt;dbl&gt;, Barbados &lt;dbl&gt;, Belarus &lt;dbl&gt;, Belgium &lt;dbl&gt;,
#   Belize &lt;dbl&gt;, Benin &lt;dbl&gt;, Bermuda &lt;dbl&gt;, Bhutan &lt;dbl&gt;, Bolivia &lt;dbl&gt;,
#   `Bonaire Sint Eustatius and Saba` &lt;dbl&gt;, `Bosnia and Herzegovina` &lt;dbl&gt;,
#   Botswana &lt;dbl&gt;, Brazil &lt;dbl&gt;, `British Virgin Islands` &lt;dbl&gt;, ...</code></pre>
</div>
</div>
<p>Notice that now we have 225 columns rather than 67 of the original data set with each cell conveying the whole information: new cases in a given date for a specific country. So, what if we wanted to have both <code>new_cases</code> and <code>new_deaths</code> columns in wide form? We just need to provide a vector with the desired variables in <code>values_from</code>. By default, the new columns will be named according to the following pattern: <strong>variable_location</strong>.</p>
<p>Since the variables names already contain a single underscore, it’s a good idea to set a different character as separator – a double underscore works fine. This is because we might need to reverse the operation later for a given task, then it’s much easier to identify it. Otherwise, we’d have to use regular expression to inform the specific position of the repeated character – for example, whether it’s the first or the second underscore.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>covid_wide_02 <span class="ot">&lt;-</span> covid_data <span class="sc">%&gt;%</span> </span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">id_cols     =</span> <span class="st">'date'</span>, </span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_from  =</span> <span class="st">'location'</span>, </span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_from =</span> <span class="fu">c</span>(<span class="st">'new_cases'</span>, <span class="st">'new_deaths'</span>),</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_sep   =</span> <span class="st">'__'</span></span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>covid_wide_02</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 720 x 451
   date       new_cases__Afghanistan new_cases__Albania new_cases__Algeria
   &lt;date&gt;                      &lt;dbl&gt;              &lt;dbl&gt;              &lt;dbl&gt;
 1 2020-02-24                      5                 NA                 NA
 2 2020-02-25                      0                 NA                  1
 3 2020-02-26                      0                 NA                  0
 4 2020-02-27                      0                 NA                  0
 5 2020-02-28                      0                 NA                  0
 6 2020-02-29                      0                 NA                  0
 7 2020-03-01                      0                 NA                  0
 8 2020-03-02                      0                 NA                  2
 9 2020-03-03                      0                 NA                  2
10 2020-03-04                      0                 NA                  7
# ... with 710 more rows, and 447 more variables: new_cases__Andorra &lt;dbl&gt;,
#   new_cases__Angola &lt;dbl&gt;, new_cases__Anguilla &lt;dbl&gt;,
#   `new_cases__Antigua and Barbuda` &lt;dbl&gt;, new_cases__Argentina &lt;dbl&gt;,
#   new_cases__Armenia &lt;dbl&gt;, new_cases__Aruba &lt;dbl&gt;,
#   new_cases__Australia &lt;dbl&gt;, new_cases__Austria &lt;dbl&gt;,
#   new_cases__Azerbaijan &lt;dbl&gt;, new_cases__Bahamas &lt;dbl&gt;,
#   new_cases__Bahrain &lt;dbl&gt;, new_cases__Bangladesh &lt;dbl&gt;, ...</code></pre>
</div>
</div>
<p>Our new data set expanded to 450 columns. As we create more and more columns to get a wide data set it might become harder to perform some simple tasks. For example, using <code>filter</code> is generally easier than using a conditional <code>select</code> when we want to keep only the relevant data.</p>
<p>In summary, long format may be preferable over wide format when the data set contains more than one grouping variable or we want to work on more than one variable. Besides, long format data sets are ideal for plotting with <code>ggplot2</code> package as we’ll see later.</p>
<p>Therefore, it’s not unusual to convert a data set from wide to long format. The syntax is very similar to what we saw earlier when converting from long to wide format. The unique difference is in the <code>cols</code> argument, used to declare what columns we want to stack. However, since wide data sets usually have a large number of columns and we’re often interested in putting all of them in long format, it’s much easier to declare what columns we want to leave out (<code>-</code>).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>covid_long_01 <span class="ot">&lt;-</span> covid_wide_02 <span class="sc">%&gt;%</span> </span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">cols      =</span> <span class="sc">-</span><span class="st">'date'</span>,</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_to  =</span> <span class="fu">c</span>(<span class="st">'variable'</span>, <span class="st">'location'</span>),</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_to =</span> <span class="st">'value'</span>,</span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_sep =</span> <span class="st">'__'</span></span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a>covid_long_01</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 324,000 x 4
   date       variable  location            value
   &lt;date&gt;     &lt;chr&gt;     &lt;chr&gt;               &lt;dbl&gt;
 1 2020-02-24 new_cases Afghanistan             5
 2 2020-02-24 new_cases Albania                NA
 3 2020-02-24 new_cases Algeria                NA
 4 2020-02-24 new_cases Andorra                NA
 5 2020-02-24 new_cases Angola                 NA
 6 2020-02-24 new_cases Anguilla               NA
 7 2020-02-24 new_cases Antigua and Barbuda    NA
 8 2020-02-24 new_cases Argentina              NA
 9 2020-02-24 new_cases Armenia                NA
10 2020-02-24 new_cases Aruba                  NA
# ... with 323,990 more rows</code></pre>
</div>
</div>
<p>Note that now even the variables (new_cases and new_deaths) are stored in a single column (variable). This is probably an abuse of language, but I call this a complete long format – as opposed to the original format where the data set was only partially in the long format (the variables were indeed in wide format). For most applications, I think this is the best way to organize the data.</p>
<p>Converting a data set between wide and long formats might not completely solve our problem. Sometimes, two pieces of information are merged in a single column. For example, suppose that the <code>location</code> column had both the continent and country names instead of only the country as in the original data set. We’ll call this data set <code>covid_loc_cont</code>.</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 139,819 x 4
   location         date       new_cases new_deaths
   &lt;chr&gt;            &lt;date&gt;         &lt;dbl&gt;      &lt;dbl&gt;
 1 Afghanistan_Asia 2020-02-24         5         NA
 2 Afghanistan_Asia 2020-02-25         0         NA
 3 Afghanistan_Asia 2020-02-26         0         NA
 4 Afghanistan_Asia 2020-02-27         0         NA
 5 Afghanistan_Asia 2020-02-28         0         NA
 6 Afghanistan_Asia 2020-02-29         0         NA
 7 Afghanistan_Asia 2020-03-01         0         NA
 8 Afghanistan_Asia 2020-03-02         0         NA
 9 Afghanistan_Asia 2020-03-03         0         NA
10 Afghanistan_Asia 2020-03-04         0         NA
# ... with 139,809 more rows</code></pre>
</div>
</div>
<p>This is undesirable since we can no longer use <code>group_by</code> or <code>filter</code> over either country or continents names alone, for instance. Hence, the best practice is to have a single column for each variable. This can be easily achieved using the <code>separate</code> function, with a highly self-explanatory syntax. Again, the separator character being unique in the string makes the job much easier.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>covid_separate <span class="ot">&lt;-</span> covid_loc_cont <span class="sc">%&gt;%</span> </span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">separate</span>(</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">col  =</span> <span class="st">'location'</span>,</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">into =</span> <span class="fu">c</span>(<span class="st">'location'</span>, <span class="st">'continent'</span>),</span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">sep  =</span> <span class="st">'_'</span></span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>covid_separate</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 139,819 x 5
   location    continent date       new_cases new_deaths
   &lt;chr&gt;       &lt;chr&gt;     &lt;date&gt;         &lt;dbl&gt;      &lt;dbl&gt;
 1 Afghanistan Asia      2020-02-24         5         NA
 2 Afghanistan Asia      2020-02-25         0         NA
 3 Afghanistan Asia      2020-02-26         0         NA
 4 Afghanistan Asia      2020-02-27         0         NA
 5 Afghanistan Asia      2020-02-28         0         NA
 6 Afghanistan Asia      2020-02-29         0         NA
 7 Afghanistan Asia      2020-03-01         0         NA
 8 Afghanistan Asia      2020-03-02         0         NA
 9 Afghanistan Asia      2020-03-03         0         NA
10 Afghanistan Asia      2020-03-04         0         NA
# ... with 139,809 more rows</code></pre>
</div>
</div>
<p>The only caveat to all this simplicity is when we have non-trivial separators. For example, imagine that we had no underscore to separate location from continent.</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 139,819 x 4
   location        date       new_cases new_deaths
   &lt;chr&gt;           &lt;date&gt;         &lt;dbl&gt;      &lt;dbl&gt;
 1 AfghanistanAsia 2020-02-24         5         NA
 2 AfghanistanAsia 2020-02-25         0         NA
 3 AfghanistanAsia 2020-02-26         0         NA
 4 AfghanistanAsia 2020-02-27         0         NA
 5 AfghanistanAsia 2020-02-28         0         NA
 6 AfghanistanAsia 2020-02-29         0         NA
 7 AfghanistanAsia 2020-03-01         0         NA
 8 AfghanistanAsia 2020-03-02         0         NA
 9 AfghanistanAsia 2020-03-03         0         NA
10 AfghanistanAsia 2020-03-04         0         NA
# ... with 139,809 more rows</code></pre>
</div>
</div>
<p>How could we manage to separate them? Ideally, we should provide a regular expression (or simply regex) to match the appropriate pattern to split the string into location and continent (the <code>sep</code> argument works with regex). If you don’t know what regex is, think of it as a code used to match patterns, positions and all kinds of features in a string.</p>
<p>At first glance, a natural choice would be to split the string as of the second uppercase letter. This would work for Afghanistan, France, Netherlands, Chile and all single-worded countries. However, this would fail for countries with two or more words: United States, New Zealand and many others.</p>
<p>Then, you could argue that a more general approach would be to use regex to match the last uppercase letter in the string. Not actually, because we have a couple of two-worded continents: North America and South America. So, for example, <strong>CanadaNorth America</strong> would be split into <strong>CanadaNorth</strong> and <strong>America</strong> instead of <strong>Canada</strong> and <strong>North America</strong>.</p>
<p>More often than not, the direct solution is the most difficult to implement (or we simply don’t know how to accomplish it) and so we have to think about alternative ways. Data science is all about this. Since a regex solution alone might be very tough or even unfeasible, we’ll get back to this problem later when covering text manipulation with the <code>stringr</code> package.</p>
<p>For now, let’s just get done with the <code>tidyr</code> package looking at two other very commonly used functions. The first one is <code>unite</code>, which is the counterpart of <code>separate</code>. We can use it to convert the <code>covid_separate</code> data frame back to the original form as in <code>covid_loc_cont</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>covid_unite <span class="ot">&lt;-</span> covid_separate <span class="sc">%&gt;%</span> </span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unite</span>(</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">col =</span> <span class="st">'location'</span>, </span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">c</span>(<span class="st">'location'</span>, <span class="st">'continent'</span>),</span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">sep =</span> <span class="st">'_'</span>)</span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>covid_unite</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 139,819 x 4
   location         date       new_cases new_deaths
   &lt;chr&gt;            &lt;date&gt;         &lt;dbl&gt;      &lt;dbl&gt;
 1 Afghanistan_Asia 2020-02-24         5         NA
 2 Afghanistan_Asia 2020-02-25         0         NA
 3 Afghanistan_Asia 2020-02-26         0         NA
 4 Afghanistan_Asia 2020-02-27         0         NA
 5 Afghanistan_Asia 2020-02-28         0         NA
 6 Afghanistan_Asia 2020-02-29         0         NA
 7 Afghanistan_Asia 2020-03-01         0         NA
 8 Afghanistan_Asia 2020-03-02         0         NA
 9 Afghanistan_Asia 2020-03-03         0         NA
10 Afghanistan_Asia 2020-03-04         0         NA
# ... with 139,809 more rows</code></pre>
</div>
</div>
<p>And finally the <code>nest</code> function. The <code>nest</code> function is usually used in conjunction with <code>group_by</code> in order to create a new format of data frame in which every cell is now a list rather than a single observation and, thus, might store any kind of object – data frames, lists, models, plots and so forth.</p>
<p>The example below shows how to create a nested data frame for the covid data grouped by country. Note that each cell on column <code>data</code> is now a data frame itself corresponding to the data for each country.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>covid_eu_nest <span class="ot">&lt;-</span> covid_data <span class="sc">%&gt;%</span> </span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(continent <span class="sc">==</span> <span class="st">'Europe'</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(location) <span class="sc">%&gt;%</span> </span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">nest</span>()</span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>covid_eu_nest</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 51 x 2
# Groups:   location [51]
   location               data               
   &lt;chr&gt;                  &lt;list&gt;             
 1 Albania                &lt;tibble [665 x 66]&gt;
 2 Andorra                &lt;tibble [659 x 66]&gt;
 3 Austria                &lt;tibble [665 x 66]&gt;
 4 Belarus                &lt;tibble [662 x 66]&gt;
 5 Belgium                &lt;tibble [686 x 66]&gt;
 6 Bosnia and Herzegovina &lt;tibble [656 x 66]&gt;
 7 Bulgaria               &lt;tibble [653 x 66]&gt;
 8 Croatia                &lt;tibble [665 x 66]&gt;
 9 Cyprus                 &lt;tibble [653 x 66]&gt;
10 Czechia                &lt;tibble [663 x 66]&gt;
# ... with 41 more rows</code></pre>
</div>
</div>
<p>I find it most useful when we need to perform several tasks over whole data sets. For example, if we had to transform the raw data, create plots and fit models for each country in the covid data set. The base R solution in this case would be to create list of lists, which can be very confusing sometimes. We’ll come back to nested data frames when we talk about functional programming with the <code>purrr</code> package.</p>
</section>
<section id="text-manipulation" class="level3" data-number="1.3.3">
<h3 data-number="1.3.3" class="anchored" data-anchor-id="text-manipulation"><span class="header-section-number">1.3.3</span> Text manipulation</h3>
<p>The need to handle text data has grown substantially in parallel with the popularity of Machine Learning models and, more specifically, Natural Language Processing (NLP). For these more advanced applications, the challenge is to standardize a large set of (messy) texts in order to extract features which can then feed the models and generate predictions.</p>
<p>Nevertheless, knowing the basics of text manipulation is critical for everyday tasks. It includes subsetting parts of a word, detecting if specific patterns are present, replacing a sequence of characters by something else and so forth. The functions from the <code>stringr</code> package do a terrific job in simplifying all these operations and go far beyond.</p>
<p>Similarly to what we did in the previous sections, we’ll focus on the most widely used functions. Let’s start with <code>str_detect</code>, which is conveniently used in conjunction with <code>dplyr::filter</code> since it returns <code>TRUE</code> if the specific pattern is found in the string and <code>FALSE</code> otherwise.</p>
<p>For example, let’s say we want to analyze the Covid data only for North and South Americas. We’ve learned how to do so using <code>dplyr::filter</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>covid_americas <span class="ot">&lt;-</span> covid_data <span class="sc">%&gt;%</span> </span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(continent <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">'North America'</span>, <span class="st">'South America'</span>)) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This one is not cumbersome. But let’s pretend there were, say, 50 continents on Earth with 25 having ‘America’ in their names. Would it still make sense to write all these 25 names in a vector? Absolutely not. Since all of them share a common pattern, we can easily employ <code>str_detect</code> to do the trick.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>covid_americas <span class="ot">&lt;-</span> covid_data <span class="sc">%&gt;%</span> </span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(stringr<span class="sc">::</span><span class="fu">str_detect</span>(continent, <span class="st">'America'</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Note that we could have left aside several characters using only, say, ‘Am’ or ‘Ame’. This would have worked fine if there was no other continent with this sequence of characters. Of course, this parsimony makes more sense for lengthy words or long sentences. For short words I recommended you to write the full word in order to prevent any undesirable output.In addition, we can also provide multiple patterns to <code>str_detect</code> by separating them with a <code>|</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>covid_americas <span class="ot">&lt;-</span> covid_data <span class="sc">%&gt;%</span> </span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(stringr<span class="sc">::</span><span class="fu">str_detect</span>(continent, <span class="st">'South|North'</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Finally, we may use the <code>negate = TRUE</code> argument if we’re interested in the opposite of the pattern we provide – pretty much like <code>!</code> in conditions. It’s specially useful when we want to keep most categories but one (or a few). For example, suppose that now we want to analyze every continent except for Asia. Instead of writing them all, we could simply do the following:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>covid_exAsia <span class="ot">&lt;-</span> covid_data <span class="sc">%&gt;%</span> </span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">str_detect</span>(continent, <span class="st">'Asia'</span>, <span class="at">negate =</span> <span class="cn">TRUE</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Another recurrent task when we’re dealing with strings is to remove a part of it. It’s generally required in order to establish a standard within categories so we can perform further operations. The complexity of this task vary depending on the form of this undesired part.</p>
<p>The most simple case is when we have to remove a sequence of characters which is fixed both in length and in position. For example, suppose we have a data frame <code>covid_numCont</code> in which the observations in the continent column starts with a random number from 0 to 9 – think of it as a typing error from the source, since the same reasoning applies if those random numbers were present only in a few observations.</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 10 x 4
   continent       location                         date       new_cases
   &lt;chr&gt;           &lt;chr&gt;                            &lt;date&gt;         &lt;dbl&gt;
 1 2.Africa        Somalia                          2021-05-03         0
 2 7.Asia          Qatar                            2021-02-22       463
 3 4.Asia          Palestine                        2020-11-20      1472
 4 7.Asia          Hong Kong                        2020-08-20        18
 5 3.Asia          Yemen                            2020-10-21         0
 6 7.South America Suriname                         2021-11-28        19
 7 2.North America Saint Vincent and the Grenadines 2020-05-10         0
 8 4.South America Colombia                         2021-05-31     23177
 9 2.Africa        Saint Helena                     2021-02-25         0
10 6.Africa        Gabon                            2021-05-22         0</code></pre>
</div>
</div>
<p>To solve this is solely a matter of subsetting the string from position three onwards using <code>str_sub</code>. The <code>end</code> argument defaults to last character, so we don’t need to explicit it.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>covid_numCont <span class="sc">%&gt;%</span> </span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">continent =</span> <span class="fu">str_sub</span>(continent, <span class="at">start =</span> <span class="dv">3</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 139,819 x 4
   continent location    date       new_cases
   &lt;chr&gt;     &lt;chr&gt;       &lt;date&gt;         &lt;dbl&gt;
 1 Asia      Afghanistan 2020-02-24         5
 2 Asia      Afghanistan 2020-02-25         0
 3 Asia      Afghanistan 2020-02-26         0
 4 Asia      Afghanistan 2020-02-27         0
 5 Asia      Afghanistan 2020-02-28         0
 6 Asia      Afghanistan 2020-02-29         0
 7 Asia      Afghanistan 2020-03-01         0
 8 Asia      Afghanistan 2020-03-02         0
 9 Asia      Afghanistan 2020-03-03         0
10 Asia      Afghanistan 2020-03-04         0
# ... with 139,809 more rows</code></pre>
</div>
</div>
<p>Nice. But what if the random numbers ranged from 0 to 10?</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 10 x 4
   continent  location     date       new_cases
   &lt;chr&gt;      &lt;chr&gt;        &lt;date&gt;         &lt;dbl&gt;
 1 10.Africa  Senegal      2020-09-15       223
 2 5.Asia     Indonesia    2020-08-09      1893
 3 5.Asia     Bangladesh   2020-10-18      1274
 4 5.Africa   South Africa 2020-09-11      1960
 5 10.Oceania Cook Islands 2021-08-01         0
 6 2.Africa   Seychelles   2021-04-02        41
 7 8.Asia     Saudi Arabia 2021-04-26       958
 8 8.Europe   Gibraltar    2021-02-10         7
 9 1.Asia     Oman         2020-11-11       302
10 8.Europe   France       2021-11-16     19778</code></pre>
</div>
</div>
<p>With an extra digit, we could no longer resort to the previous solution. I don’t intend to dedicate an exclusive section to regular expressions, but simple examples will eventually show up throughout the book. In this case, we could use a simple regular expression inside <code>str_remove</code> to get rid of everything before and up to the <code>.</code>, <code>.*\\.</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>covid_numCont <span class="sc">%&gt;%</span> </span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">continent =</span> <span class="fu">str_remove</span>(continent, <span class="st">".*</span><span class="sc">\\</span><span class="st">."</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 139,819 x 4
   continent location    date       new_cases
   &lt;chr&gt;     &lt;chr&gt;       &lt;date&gt;         &lt;dbl&gt;
 1 Asia      Afghanistan 2020-02-24         5
 2 Asia      Afghanistan 2020-02-25         0
 3 Asia      Afghanistan 2020-02-26         0
 4 Asia      Afghanistan 2020-02-27         0
 5 Asia      Afghanistan 2020-02-28         0
 6 Asia      Afghanistan 2020-02-29         0
 7 Asia      Afghanistan 2020-03-01         0
 8 Asia      Afghanistan 2020-03-02         0
 9 Asia      Afghanistan 2020-03-03         0
10 Asia      Afghanistan 2020-03-04         0
# ... with 139,809 more rows</code></pre>
</div>
</div>
<p>Typing errors may arise under different forms along the character column. These cases usually require a more thorough evaluation and, more often than not, the solution is to manually replace the wrong words by the correct ones. For instance, in the data frame below (named <code>covid_typo</code>) we can find two different typos for North America: there’s a missing <strong>h</strong> in rows 1 and 5; whereas there’s an extra <strong>h</strong> in rows 3 and 8.</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 22,308 x 4
   continent      location date       new_cases
   &lt;chr&gt;          &lt;chr&gt;    &lt;date&gt;         &lt;dbl&gt;
 1 Nort America   Anguilla 2020-03-28         2
 2 North America  Anguilla 2020-03-29         0
 3 Northh America Anguilla 2020-03-30         0
 4 North America  Anguilla 2020-03-31         0
 5 Nort America   Anguilla 2020-04-01         0
 6 North America  Anguilla 2020-04-02         1
 7 North America  Anguilla 2020-04-03         0
 8 Northh America Anguilla 2020-04-04         0
 9 North America  Anguilla 2020-04-05         0
10 North America  Anguilla 2020-04-06         0
# ... with 22,298 more rows</code></pre>
</div>
</div>
<p>Since the data frame contains a huge number of observations, it may be present in other positions as well. We can use <code>str_replace</code> to fix it for the whole column.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>covid_typo <span class="sc">%&gt;%</span> </span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">continent =</span> <span class="fu">str_replace</span>(continent, <span class="st">'Nort America'</span>, <span class="st">'North America'</span>),</span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">continent =</span> <span class="fu">str_replace</span>(continent, <span class="st">'Northh America'</span>, <span class="st">'North America'</span>)</span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Or we can simply pass a vector with all the replacements to the <code>str_replace_all</code> function.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>covid_typo <span class="sc">%&gt;%</span> </span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">continent =</span> stringr<span class="sc">::</span><span class="fu">str_replace_all</span>(</span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a>      continent, </span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a>      <span class="fu">c</span>(<span class="st">'Nort America'</span>   <span class="ot">=</span> <span class="st">'North America'</span>,</span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Northh America'</span> <span class="ot">=</span> <span class="st">'North America'</span>)</span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb51-8"><a href="#cb51-8" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>There’s one last kind of typo we can’t help but mention: whitespace. Whitespaces are particularly troublesome when they’re misplaced in the start/end of string or repeated inside it. Because they’re very easy to go unnoticed the <code>stringr</code> package contains two functions to cope with them: <code>str_trim</code> and <code>str_squish</code>. The former removes whitespaces from start/end of the string, whereas the later removes them from inside of a string.</p>
<p>The data frame below (named <code>covid_ws</code>) uses the same example as above, but now with a whitespace in the end of observations 1 and 5; and a repeated whitespace inside the observations 3 and 8. Note that <code>tibble</code> automatically adds quotation marks around the strings to highlight the extra whitespaces. This is awesome!</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 22,308 x 4
   continent        location date       new_cases
   &lt;chr&gt;            &lt;chr&gt;    &lt;date&gt;         &lt;dbl&gt;
 1 "North America " Anguilla 2020-03-28         2
 2 "North America"  Anguilla 2020-03-29         0
 3 "North  America" Anguilla 2020-03-30         0
 4 "North America"  Anguilla 2020-03-31         0
 5 "North America " Anguilla 2020-04-01         0
 6 "North America"  Anguilla 2020-04-02         1
 7 "North America"  Anguilla 2020-04-03         0
 8 "North  America" Anguilla 2020-04-04         0
 9 "North America"  Anguilla 2020-04-05         0
10 "North America"  Anguilla 2020-04-06         0
# ... with 22,298 more rows</code></pre>
</div>
</div>
<p>We can easily get rid of the whitespaces using those functions. It’s advisable to use them as a preprocessing step whenever we’re working with character columns that should not have these extra whitespaces.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>covid_ws <span class="sc">%&gt;%</span> </span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">continent =</span> continent <span class="sc">%&gt;%</span> </span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a>      <span class="fu">str_trim</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a>      <span class="fu">str_squish</span>()</span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>To finish up, let’s use the tools we’ve just learned to solve the problem we’ve left over from the previous subsection. To recap, we wanted to separate the column <code>location</code> into country and continent. The issue was that with no separator character between the two names, we should resort to any kind of complicated regular expression to do the trick.</p>
<div class="cell" data-opts.label="data_lay_example">
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 139,819 x 4
   location        date       new_cases new_deaths
   &lt;chr&gt;           &lt;date&gt;         &lt;dbl&gt;      &lt;dbl&gt;
 1 AfghanistanAsia 2020-02-24         5         NA
 2 AfghanistanAsia 2020-02-25         0         NA
 3 AfghanistanAsia 2020-02-26         0         NA
 4 AfghanistanAsia 2020-02-27         0         NA
 5 AfghanistanAsia 2020-02-28         0         NA
 6 AfghanistanAsia 2020-02-29         0         NA
 7 AfghanistanAsia 2020-03-01         0         NA
 8 AfghanistanAsia 2020-03-02         0         NA
 9 AfghanistanAsia 2020-03-03         0         NA
10 AfghanistanAsia 2020-03-04         0         NA
# ... with 139,809 more rows</code></pre>
</div>
</div>
<p>As I said earlier, data science is all about finding workarounds. Of course we’re often interested in general approaches, but sometimes we have to settle for a lower level solution which gets the job done. For example, in this case we could waste a long time figuring out the best possible solution whereas a simpler one is at hand.</p>
<p>This simpler solution consists of employing the <code>str_extract</code> function to extract the name of the continents in conjunction with <code>str_remove</code> to remove them from the original column. Remember that multiple patterns should be provided as a single string with these patterns separated by <code>|</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>continents <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">'Asia'</span>,</span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">'Europe'</span>,</span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">'Africa'</span>, </span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a>  <span class="st">'South America'</span>,</span>
<span id="cb55-6"><a href="#cb55-6" aria-hidden="true" tabindex="-1"></a>  <span class="st">'North America'</span>,</span>
<span id="cb55-7"><a href="#cb55-7" aria-hidden="true" tabindex="-1"></a>  <span class="st">'Oceania'</span></span>
<span id="cb55-8"><a href="#cb55-8" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span> </span>
<span id="cb55-9"><a href="#cb55-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">paste0</span>(<span class="at">collapse =</span> <span class="st">'|'</span>)</span>
<span id="cb55-10"><a href="#cb55-10" aria-hidden="true" tabindex="-1"></a>covid_loc_cont2 <span class="sc">%&gt;%</span> </span>
<span id="cb55-11"><a href="#cb55-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb55-12"><a href="#cb55-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">continent =</span> <span class="fu">str_extract</span>(</span>
<span id="cb55-13"><a href="#cb55-13" aria-hidden="true" tabindex="-1"></a>      location,</span>
<span id="cb55-14"><a href="#cb55-14" aria-hidden="true" tabindex="-1"></a>      continents</span>
<span id="cb55-15"><a href="#cb55-15" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb55-16"><a href="#cb55-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">location =</span> <span class="fu">str_remove</span>(</span>
<span id="cb55-17"><a href="#cb55-17" aria-hidden="true" tabindex="-1"></a>      location,</span>
<span id="cb55-18"><a href="#cb55-18" aria-hidden="true" tabindex="-1"></a>      continents</span>
<span id="cb55-19"><a href="#cb55-19" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb55-20"><a href="#cb55-20" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 139,819 x 5
   location    date       new_cases new_deaths continent
   &lt;chr&gt;       &lt;date&gt;         &lt;dbl&gt;      &lt;dbl&gt; &lt;chr&gt;    
 1 Afghanistan 2020-02-24         5         NA Asia     
 2 Afghanistan 2020-02-25         0         NA Asia     
 3 Afghanistan 2020-02-26         0         NA Asia     
 4 Afghanistan 2020-02-27         0         NA Asia     
 5 Afghanistan 2020-02-28         0         NA Asia     
 6 Afghanistan 2020-02-29         0         NA Asia     
 7 Afghanistan 2020-03-01         0         NA Asia     
 8 Afghanistan 2020-03-02         0         NA Asia     
 9 Afghanistan 2020-03-03         0         NA Asia     
10 Afghanistan 2020-03-04         0         NA Asia     
# ... with 139,809 more rows</code></pre>
</div>
</div>
<p>Job done! Next we turn to dates, which is a special form of string. Handling them properly is essential to analyze time series data.</p>
</section>
<section id="date-manipulation" class="level3" data-number="1.3.4">
<h3 data-number="1.3.4" class="anchored" data-anchor-id="date-manipulation"><span class="header-section-number">1.3.4</span> Date manipulation</h3>
<p>Having knowledge on date manipulation is crucial to perform a lot of tasks when we’re dealing with time series data. Date objects are very convenient since they allow us to extract features that can be used for many purposes. The subject is so vast that the <code>lubridate</code> package was created exclusively to handle date objects.</p>
<p>The first step when we’re working with dates is to convert the string to a date object. In order to get rid of ambiguity issues, <code>lubridate</code> contains a set of predefined functions that take into account the ordering of year, month and day in the string.</p>
<p>For instance, if we have a date in the standard <code>YYYY-MM-DD</code> format we can use the <code>ymd</code> function. Note that it works regardless of how these terms are separated: it might be like <code>2021-12-01</code>, <code>2022/12/01</code> or even <code>20221201</code>. Also, months names (full or abbreviated forms) are allowed: <code>2021-December-01</code> or <code>2021-Dec-01</code>. The same logic applies to the whole family of related functions: <code>mdy</code>, <code>dmy</code>, <code>ydm</code>, <code>dym</code>, <code>my</code>, <code>ym</code> and so on.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lubridate)</span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ymd</span>(<span class="st">'2022/12/01'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "2022-12-01"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mdy</span>(<span class="st">'december, 1, 2022'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "2022-12-01"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="fu">dmy</span>(<span class="st">'01122022'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "2022-12-01"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="fu">my</span>(<span class="st">'Dec-2021'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "2021-12-01"</code></pre>
</div>
</div>
<p>In case the string format doesn’t match any of the predefined patterns, we can use <code>lubridate::as_date</code> function and declare the unusual format using specific operators: <code>%Y</code> for year; <code>%m</code> for month; and <code>%d</code> for day. There are two other useful ones: <code>%b</code> for months names (full or abbreviated) and <code>%y</code> for two-digits year.</p>
<p>Now, let’s see how to extract features from date objects and how to use them to perform common operations. Take the following data set (named <code>brl_usd</code>) which provides daily values of the Brazilian Real (BRL) versus the US Dollar from January 2010 to December 2021 where the column <code>date</code> is in the <code>DD/MM/YYYY</code> format.</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3,014 x 2
   date        brl
   &lt;chr&gt;     &lt;dbl&gt;
 1 4/1/2010   1.72
 2 5/1/2010   1.72
 3 6/1/2010   1.73
 4 7/1/2010   1.74
 5 8/1/2010   1.74
 6 11/1/2010  1.73
 7 12/1/2010  1.74
 8 13/1/2010  1.74
 9 14/1/2010  1.76
10 15/1/2010  1.77
# ... with 3,004 more rows</code></pre>
</div>
</div>
<p>Note that the column date is in standard string (or character) format. We’ll first convert it to the appropriate date format using the functions we’ve just learned.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a>brl_usd_aux <span class="ot">&lt;-</span> brl_usd <span class="sc">%&gt;%</span> </span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">date =</span> <span class="fu">dmy</span>(date))</span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a>brl_usd_aux</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3,014 x 2
   date         brl
   &lt;date&gt;     &lt;dbl&gt;
 1 2010-01-04  1.72
 2 2010-01-05  1.72
 3 2010-01-06  1.73
 4 2010-01-07  1.74
 5 2010-01-08  1.74
 6 2010-01-11  1.73
 7 2010-01-12  1.74
 8 2010-01-13  1.74
 9 2010-01-14  1.76
10 2010-01-15  1.77
# ... with 3,004 more rows</code></pre>
</div>
</div>
<p>Now, suppose we want to obtain BRL monthly average. We have two ways to do this, one that is more logical and one that is more compact (see later when we talk about rounding dates). In the logical way, all we have to do is to create the columns we need to perform a grouping operation: year and month.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a>brl_usd_monthly <span class="ot">&lt;-</span> brl_usd_aux <span class="sc">%&gt;%</span> </span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">year  =</span> <span class="fu">year</span>(date),</span>
<span id="cb68-4"><a href="#cb68-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">month =</span> <span class="fu">month</span>(date)</span>
<span id="cb68-5"><a href="#cb68-5" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb68-6"><a href="#cb68-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(year, month) <span class="sc">%&gt;%</span> </span>
<span id="cb68-7"><a href="#cb68-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">brl_monthly =</span> <span class="fu">mean</span>(brl))</span>
<span id="cb68-8"><a href="#cb68-8" aria-hidden="true" tabindex="-1"></a>brl_usd_monthly</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 144 x 3
# Groups:   year [12]
    year month brl_monthly
   &lt;dbl&gt; &lt;dbl&gt;       &lt;dbl&gt;
 1  2010     1        1.78
 2  2010     2        1.84
 3  2010     3        1.79
 4  2010     4        1.76
 5  2010     5        1.81
 6  2010     6        1.81
 7  2010     7        1.77
 8  2010     8        1.76
 9  2010     9        1.72
10  2010    10        1.68
# ... with 134 more rows</code></pre>
</div>
</div>
<p>You might be wondering how to recover the date format <code>YYYY-MM-DD</code>. We can do it by simply using the <code>make_date</code> function. This function creates a standard date object from user-provided year, month and day. Since we’ve aggregated daily into monthly, we have two common choices for the day parameter: we either set it to 1 (the default) or we set it to the last day of the month using <code>days_in_month</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a>brl_usd_monthly <span class="sc">%&gt;%</span> </span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">date =</span> <span class="fu">make_date</span>(</span>
<span id="cb70-4"><a href="#cb70-4" aria-hidden="true" tabindex="-1"></a>      <span class="at">year  =</span> year, </span>
<span id="cb70-5"><a href="#cb70-5" aria-hidden="true" tabindex="-1"></a>      <span class="at">month =</span> month, </span>
<span id="cb70-6"><a href="#cb70-6" aria-hidden="true" tabindex="-1"></a>      <span class="at">day   =</span> <span class="dv">1</span>),</span>
<span id="cb70-7"><a href="#cb70-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">date2 =</span> <span class="fu">make_date</span>(</span>
<span id="cb70-8"><a href="#cb70-8" aria-hidden="true" tabindex="-1"></a>      <span class="at">year =</span> year, </span>
<span id="cb70-9"><a href="#cb70-9" aria-hidden="true" tabindex="-1"></a>      <span class="at">month =</span> month,</span>
<span id="cb70-10"><a href="#cb70-10" aria-hidden="true" tabindex="-1"></a>      <span class="at">day   =</span> <span class="fu">days_in_month</span>(date)</span>
<span id="cb70-11"><a href="#cb70-11" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb70-12"><a href="#cb70-12" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 144 x 5
# Groups:   year [12]
    year month brl_monthly date       date2     
   &lt;dbl&gt; &lt;dbl&gt;       &lt;dbl&gt; &lt;date&gt;     &lt;date&gt;    
 1  2010     1        1.78 2010-01-01 2010-01-31
 2  2010     2        1.84 2010-02-01 2010-02-28
 3  2010     3        1.79 2010-03-01 2010-03-31
 4  2010     4        1.76 2010-04-01 2010-04-30
 5  2010     5        1.81 2010-05-01 2010-05-31
 6  2010     6        1.81 2010-06-01 2010-06-30
 7  2010     7        1.77 2010-07-01 2010-07-31
 8  2010     8        1.76 2010-08-01 2010-08-31
 9  2010     9        1.72 2010-09-01 2010-09-30
10  2010    10        1.68 2010-10-01 2010-10-31
# ... with 134 more rows</code></pre>
</div>
</div>
<p>Note that creating a column with the number of days in each month may be itself particularly useful. For instance, when we have only the monthly totals of a variable and we need to compute daily averages. And, of course, it works fine with February since it takes the year into account.</p>
<p>The same procedure applies if we want to get quarterly means. It’s just a matter of creating a column with quarters. Be aware, however, that the <code>quarter</code> function has a parameter named <code>with_year</code> that when set to <code>TRUE</code> eliminates the need to create a separate column for the year.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a>brl_usd_quarterly <span class="ot">&lt;-</span> brl_usd_aux <span class="sc">%&gt;%</span> </span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">quarter =</span> <span class="fu">quarter</span>(date, <span class="at">with_year =</span> <span class="cn">TRUE</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb72-3"><a href="#cb72-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(quarter) <span class="sc">%&gt;%</span> </span>
<span id="cb72-4"><a href="#cb72-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">brl_quarterly =</span> <span class="fu">mean</span>(brl))</span>
<span id="cb72-5"><a href="#cb72-5" aria-hidden="true" tabindex="-1"></a>brl_usd_quarterly</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 48 x 2
   quarter brl_quarterly
     &lt;dbl&gt;         &lt;dbl&gt;
 1   2010.          1.80
 2   2010.          1.79
 3   2010.          1.75
 4   2010.          1.70
 5   2011.          1.67
 6   2011.          1.60
 7   2011.          1.64
 8   2011.          1.80
 9   2012.          1.77
10   2012.          1.96
# ... with 38 more rows</code></pre>
</div>
</div>
<p>Special attention must be taken when we want to work with weeks, because <code>lubridate</code> has two different functions to extract this feature: <code>week</code> and <code>isoweek</code>. The former returns the number of complete seven day periods that have occurred between the date and January 1st, while the latter returns the number of the week (from Monday to Sunday) the date belongs to.</p>
<p>To get a better sense of the difference between them, suppose we provide the date ‘2022-01-01’. <code>week</code> will return 1, since it’s in the first seven days period after January 1st. On the other hand, <code>isoweek</code> will return 52 because it’s Saturday and thus part of the last week of the previous year. It’ll only return 1 as of ‘2022-01-03’ since it belongs to a new week.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a><span class="fu">week</span>(<span class="st">'2022-01-01'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1</code></pre>
</div>
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a><span class="fu">isoweek</span>(<span class="st">'2022-01-01'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 52</code></pre>
</div>
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a><span class="fu">isoweek</span>(<span class="st">'2022-01-03'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1</code></pre>
</div>
</div>
<p>Therefore, if we want to compute weekly averages and by weekly we mean a period of seven days in a row then we should pick <code>isoweek</code> instead of <code>week</code>. Another feature we can extract from dates is the week day. In addition to temporal aggregation, it’s often used to filter or label data we want to plot later.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb80"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a>brl_usd_aux <span class="sc">%&gt;%</span> </span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">wday =</span> <span class="fu">wday</span>(date, <span class="at">label =</span> <span class="cn">TRUE</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3,014 x 3
   date         brl wday 
   &lt;date&gt;     &lt;dbl&gt; &lt;ord&gt;
 1 2010-01-04  1.72 Mon  
 2 2010-01-05  1.72 Tue  
 3 2010-01-06  1.73 Wed  
 4 2010-01-07  1.74 Thu  
 5 2010-01-08  1.74 Fri  
 6 2010-01-11  1.73 Mon  
 7 2010-01-12  1.74 Tue  
 8 2010-01-13  1.74 Wed  
 9 2010-01-14  1.76 Thu  
10 2010-01-15  1.77 Fri  
# ... with 3,004 more rows</code></pre>
</div>
</div>
<p>Now we turn to operations with date objects. The <code>lubridate</code> package contains two special operators <code>%m+%</code> and <code>%m-%</code> that work nicely with date objects to perform, respectively, addition and subtraction.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb82"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a>d1 <span class="ot">&lt;-</span> <span class="fu">ymd</span>(<span class="st">'2020-02-29'</span>)</span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a>d1 <span class="sc">%m+%</span> <span class="fu">years</span>(<span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "2022-02-28"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb84"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a>d1 <span class="sc">%m-%</span> <span class="fu">months</span>(<span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "2019-11-29"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb86"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a>d1 <span class="sc">%m+%</span> <span class="fu">days</span>(<span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "2020-03-01"</code></pre>
</div>
</div>
<p>In addition, there’s also the lesser known <code>add_with_rollback</code> function which we can use to have more control of the output. For example, when adding one month to 2022-01-31 we might want either 2022-02-28 (the last day of the next month) or 2022-03-01 (a period of one month). To get the latter, we set the <code>roll_to_first</code> parameter to <code>TRUE</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb88"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a>d2 <span class="ot">&lt;-</span> <span class="fu">ymd</span>(<span class="st">'2022-01-31'</span>)</span>
<span id="cb88-2"><a href="#cb88-2" aria-hidden="true" tabindex="-1"></a><span class="fu">add_with_rollback</span>(d2, <span class="fu">months</span>(<span class="dv">1</span>), <span class="at">roll_to_first =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "2022-03-01"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb90"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a><span class="fu">add_with_rollback</span>(d2, <span class="fu">months</span>(<span class="dv">1</span>), <span class="at">roll_to_first =</span> <span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "2022-02-28"</code></pre>
</div>
</div>
<p>I couldn’t help but mention two useful functions used to round dates: <code>floor_date</code> and <code>ceiling_date</code>. They take a date object and rounds it down or up, respectively, to the nearest boundary of the specified time unit.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb92"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a>d3 <span class="ot">&lt;-</span> <span class="fu">ymd</span>(<span class="st">'2021-03-13'</span>)</span>
<span id="cb92-2"><a href="#cb92-2" aria-hidden="true" tabindex="-1"></a><span class="fu">floor_date</span>(d3,   <span class="at">unit =</span> <span class="st">'month'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "2021-03-01"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb94"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ceiling_date</span>(d3, <span class="at">unit =</span> <span class="st">'month'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "2021-04-01"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb96"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a><span class="fu">floor_date</span>(d3,   <span class="at">unit =</span> <span class="st">'quarter'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "2021-01-01"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb98"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ceiling_date</span>(d3, <span class="at">unit =</span> <span class="st">'quarter'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "2021-04-01"</code></pre>
</div>
</div>
<p>These functions can be helpful in several ways and you’ll find their benefits as you go through your own tasks. For example, if we want to match (or re-write) dates that refer to the same period but are written differently (monthly date in data set A is ‘2021-12-01’ and in data set B is ‘2021-12-31’).</p>
<p>I use them very often as a simpler way to perform temporal aggregation. Remember that earlier in this section we computed monthly averages by creating two grouping columns, year and month. The logic was simply to treat every day in the same year/month as belonging to the same group. We can easily accomplish the same result by rounding dates down, with the great benefit of preserving the date column.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb100"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a>brl_usd_monthly2 <span class="ot">&lt;-</span> brl_usd_aux <span class="sc">%&gt;%</span> </span>
<span id="cb100-2"><a href="#cb100-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">date =</span> <span class="fu">floor_date</span>(date, <span class="at">unit =</span> <span class="st">'month'</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb100-3"><a href="#cb100-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(date) <span class="sc">%&gt;%</span> </span>
<span id="cb100-4"><a href="#cb100-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">brl_monthly =</span> <span class="fu">mean</span>(brl))</span>
<span id="cb100-5"><a href="#cb100-5" aria-hidden="true" tabindex="-1"></a>brl_usd_monthly2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 144 x 2
   date       brl_monthly
   &lt;date&gt;           &lt;dbl&gt;
 1 2010-01-01        1.78
 2 2010-02-01        1.84
 3 2010-03-01        1.79
 4 2010-04-01        1.76
 5 2010-05-01        1.81
 6 2010-06-01        1.81
 7 2010-07-01        1.77
 8 2010-08-01        1.76
 9 2010-09-01        1.72
10 2010-10-01        1.68
# ... with 134 more rows</code></pre>
</div>
</div>
<p>To finish up, let’s have a quick look at a family of functions: <code>wday</code>, <code>mday</code>, <code>qday</code> and <code>yday</code>. They’re used to get the number of days that have occurred within that time period, respectively.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb102"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a><span class="fu">wday</span>(<span class="st">'2021-06-10'</span>) <span class="co"># 5th day of that week</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 5</code></pre>
</div>
<div class="sourceCode cell-code" id="cb104"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb104-1"><a href="#cb104-1" aria-hidden="true" tabindex="-1"></a><span class="fu">qday</span>(<span class="st">'2021-06-10'</span>) <span class="co"># 71th day of the 2nd quarter of 2021</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 71</code></pre>
</div>
<div class="sourceCode cell-code" id="cb106"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb106-1"><a href="#cb106-1" aria-hidden="true" tabindex="-1"></a><span class="fu">yday</span>(<span class="st">'2021-06-10'</span>) <span class="co"># 161th day of 2021</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 161</code></pre>
</div>
</div>
<p>It’s very useful, for example, when you need to compare observations from the same period in different years or create high frequency seasonal variables.</p>
</section>
</section>
<section id="looping" class="level2" data-number="1.4">
<h2 data-number="1.4" class="anchored" data-anchor-id="looping"><span class="header-section-number">1.4</span> Looping</h2>
<p>Iteration is an indispensable tool in programming and every language has its own structure. Essentially, loops are used to repeat an action over a set of values, thus preventing us from the annoying and risky copying-and-pasting thing. Whenever we have any kind of redundancy, there’s a good reason to use loops.</p>
<p>The <code>purrr</code> package provides many interesting tools for working with functions and vectors. For our purposes, we’ll stick with the family of <code>map</code> functions. The logic will always be the same: applying a function – existing or user-defined – over a vector (or list) of arguments.</p>
<p>Let’s start with a very simple example. Suppose we have three numeric vectors and we want to compute their means. Instead of calling <code>mean</code> over each vector separately, we can put them into a list and then use the <code>map</code> function in conjunction with the existing <code>mean</code> function.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb108"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb108-1"><a href="#cb108-1" aria-hidden="true" tabindex="-1"></a>v1 <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">4</span>,<span class="dv">7</span>,<span class="dv">8</span>)</span>
<span id="cb108-2"><a href="#cb108-2" aria-hidden="true" tabindex="-1"></a>v2 <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">3</span>,<span class="dv">5</span>,<span class="dv">9</span>,<span class="dv">0</span>) </span>
<span id="cb108-3"><a href="#cb108-3" aria-hidden="true" tabindex="-1"></a>v3 <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">12</span>,<span class="dv">0</span>,<span class="dv">7</span>,<span class="dv">1</span>)</span>
<span id="cb108-4"><a href="#cb108-4" aria-hidden="true" tabindex="-1"></a>v_all <span class="ot">&lt;-</span> <span class="fu">list</span>(v1, v2, v3)</span>
<span id="cb108-5"><a href="#cb108-5" aria-hidden="true" tabindex="-1"></a><span class="fu">map</span>(<span class="at">.x =</span> v_all, <span class="at">.f =</span> mean)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[[1]]
[1] 5

[[2]]
[1] 4.25

[[3]]
[1] 5</code></pre>
</div>
</div>
<p>Note that by default the output will be a list, but we can have other output formats using <code>map_*</code>: <code>map_dbl</code> will return the results as a vector, whereas <code>map_dfc</code> will return them in a (column) data frame. We only need to consider whether or not the output can be coerced to the desired class.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb110"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb110-1"><a href="#cb110-1" aria-hidden="true" tabindex="-1"></a><span class="fu">map_dbl</span>(<span class="at">.x =</span> v_all, <span class="at">.f =</span> mean)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 5.00 4.25 5.00</code></pre>
</div>
<div class="sourceCode cell-code" id="cb112"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb112-1"><a href="#cb112-1" aria-hidden="true" tabindex="-1"></a><span class="fu">map_dfc</span>(<span class="at">.x =</span> v_all, <span class="at">.f =</span> mean)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 x 3
   ...1  ...2  ...3
  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
1     5  4.25     5</code></pre>
</div>
</div>
<p>Most of the time I prefer to return the results as a list, because that makes it easier to apply further operations if needed. Data frames are usually a better choice for final results.</p>
<p>Now, let’s introduce some degree of complexity to the exercise by providing our own function. For this, let’s use the example of importing data from an API we saw earlier in the Importing section. Suppose that in addition to CPI we also want to get the time series for GDP and Unemployment rate.</p>
<p>Remember (or scroll up if necessary) that we created an object called <code>api_series_id</code> with the ID of the CPI time series and that was the only specific parameter – everything else would be the same for any other series we wanted. Therefore, our first task here is to create a function whose only parameter is the series ID. Then, we create a vector (or list) with the desired series ID’s and – guess what? – use them inside the <code>map</code> function.</p>
<p>I’ll create the <code>get_series</code> function using the same content we already saw up there, but leaving the <code>api_series_id</code> as a parameter (<code>series_id</code>). Note that I’ll keep some objects with their original names – starting with <em>cpi_</em> – just to avoid confusion. This has no practical effect, though.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb114"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb114-1"><a href="#cb114-1" aria-hidden="true" tabindex="-1"></a>get_series <span class="ot">&lt;-</span> <span class="cf">function</span>(series_id){</span>
<span id="cb114-2"><a href="#cb114-2" aria-hidden="true" tabindex="-1"></a>  api_url       <span class="ot">&lt;-</span> <span class="st">'https://api.stlouisfed.org/fred/series/observations?'</span></span>
<span id="cb114-3"><a href="#cb114-3" aria-hidden="true" tabindex="-1"></a>  api_key       <span class="ot">&lt;-</span> api_fred_key</span>
<span id="cb114-4"><a href="#cb114-4" aria-hidden="true" tabindex="-1"></a>  api_series_id <span class="ot">&lt;-</span> series_id</span>
<span id="cb114-5"><a href="#cb114-5" aria-hidden="true" tabindex="-1"></a>  obs_start     <span class="ot">&lt;-</span> <span class="st">'2010-01-01'</span></span>
<span id="cb114-6"><a href="#cb114-6" aria-hidden="true" tabindex="-1"></a>  api_filetype  <span class="ot">&lt;-</span> <span class="st">'json'</span></span>
<span id="cb114-7"><a href="#cb114-7" aria-hidden="true" tabindex="-1"></a>  api_request   <span class="ot">&lt;-</span> glue<span class="sc">::</span><span class="fu">glue</span>(<span class="st">'{api_url}series_id={api_series_id}&amp;observation_start={obs_start}&amp;api_key={api_key}&amp;file_type={api_filetype}'</span>)</span>
<span id="cb114-8"><a href="#cb114-8" aria-hidden="true" tabindex="-1"></a>  cpi_request   <span class="ot">&lt;-</span> httr<span class="sc">::</span><span class="fu">GET</span>(<span class="at">url =</span> api_request)</span>
<span id="cb114-9"><a href="#cb114-9" aria-hidden="true" tabindex="-1"></a>  cpi_content   <span class="ot">&lt;-</span> httr<span class="sc">::</span><span class="fu">content</span>(cpi_request, <span class="at">as =</span> <span class="st">'text'</span>)</span>
<span id="cb114-10"><a href="#cb114-10" aria-hidden="true" tabindex="-1"></a>  cpi_list      <span class="ot">&lt;-</span> jsonlite<span class="sc">::</span><span class="fu">fromJSON</span>(cpi_content, <span class="at">flatten =</span> <span class="cn">FALSE</span>)</span>
<span id="cb114-11"><a href="#cb114-11" aria-hidden="true" tabindex="-1"></a>  cpi_tbl       <span class="ot">&lt;-</span> cpi_list[[<span class="st">'observations'</span>]] <span class="sc">%&gt;%</span> tibble<span class="sc">::</span><span class="fu">as_tibble</span>()</span>
<span id="cb114-12"><a href="#cb114-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(cpi_tbl)</span>
<span id="cb114-13"><a href="#cb114-13" aria-hidden="true" tabindex="-1"></a>} </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can test our function using the CPI’s ID we used before.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb115"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb115-1"><a href="#cb115-1" aria-hidden="true" tabindex="-1"></a><span class="fu">get_series</span>(<span class="at">series_id =</span> <span class="st">'CPALTT01USM657N'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 157 x 4
   realtime_start realtime_end date       value              
   &lt;chr&gt;          &lt;chr&gt;        &lt;chr&gt;      &lt;chr&gt;              
 1 2023-04-11     2023-04-11   2010-01-01 0.34174735701485   
 2 2023-04-11     2023-04-11   2010-02-01 0.024920738207648  
 3 2023-04-11     2023-04-11   2010-03-01 0.410628353657108  
 4 2023-04-11     2023-04-11   2010-04-01 0.173688491069743  
 5 2023-04-11     2023-04-11   2010-05-01 0.0775197354237721 
 6 2023-04-11     2023-04-11   2010-06-01 -0.0976267084673888
 7 2023-04-11     2023-04-11   2010-07-01 0.0211043057371509 
 8 2023-04-11     2023-04-11   2010-08-01 0.138066427840807  
 9 2023-04-11     2023-04-11   2010-09-01 0.0581736230715569 
10 2023-04-11     2023-04-11   2010-10-01 0.124519888847696  
# ... with 147 more rows</code></pre>
</div>
</div>
<p>Great, it’s working fine! The next step is to create a vector (or list) with the IDs of each series. Assigning names to the vector (list) elements is a good idea since these names are carried forward helping to identify the elements in the output list.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb117"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb117-1"><a href="#cb117-1" aria-hidden="true" tabindex="-1"></a>id_list <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb117-2"><a href="#cb117-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">'CPI'</span>   <span class="ot">=</span> <span class="st">'CPALTT01USM657N'</span>,</span>
<span id="cb117-3"><a href="#cb117-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">'GDP'</span>   <span class="ot">=</span> <span class="st">'GDPC1'</span>,</span>
<span id="cb117-4"><a href="#cb117-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">'Unemp'</span> <span class="ot">=</span> <span class="st">'UNRATE'</span></span>
<span id="cb117-5"><a href="#cb117-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb117-6"><a href="#cb117-6" aria-hidden="true" tabindex="-1"></a>fred_data <span class="ot">&lt;-</span> purrr<span class="sc">::</span><span class="fu">map</span>(<span class="at">.x =</span> id_list, <span class="at">.f =</span> get_series)</span>
<span id="cb117-7"><a href="#cb117-7" aria-hidden="true" tabindex="-1"></a>fred_data</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$CPI
# A tibble: 157 x 4
   realtime_start realtime_end date       value              
   &lt;chr&gt;          &lt;chr&gt;        &lt;chr&gt;      &lt;chr&gt;              
 1 2023-04-11     2023-04-11   2010-01-01 0.34174735701485   
 2 2023-04-11     2023-04-11   2010-02-01 0.024920738207648  
 3 2023-04-11     2023-04-11   2010-03-01 0.410628353657108  
 4 2023-04-11     2023-04-11   2010-04-01 0.173688491069743  
 5 2023-04-11     2023-04-11   2010-05-01 0.0775197354237721 
 6 2023-04-11     2023-04-11   2010-06-01 -0.0976267084673888
 7 2023-04-11     2023-04-11   2010-07-01 0.0211043057371509 
 8 2023-04-11     2023-04-11   2010-08-01 0.138066427840807  
 9 2023-04-11     2023-04-11   2010-09-01 0.0581736230715569 
10 2023-04-11     2023-04-11   2010-10-01 0.124519888847696  
# ... with 147 more rows

$GDP
# A tibble: 52 x 4
   realtime_start realtime_end date       value    
   &lt;chr&gt;          &lt;chr&gt;        &lt;chr&gt;      &lt;chr&gt;    
 1 2023-04-11     2023-04-11   2010-01-01 15456.059
 2 2023-04-11     2023-04-11   2010-04-01 15605.628
 3 2023-04-11     2023-04-11   2010-07-01 15726.282
 4 2023-04-11     2023-04-11   2010-10-01 15807.995
 5 2023-04-11     2023-04-11   2011-01-01 15769.911
 6 2023-04-11     2023-04-11   2011-04-01 15876.839
 7 2023-04-11     2023-04-11   2011-07-01 15870.684
 8 2023-04-11     2023-04-11   2011-10-01 16048.702
 9 2023-04-11     2023-04-11   2012-01-01 16179.968
10 2023-04-11     2023-04-11   2012-04-01 16253.726
# ... with 42 more rows

$Unemp
# A tibble: 159 x 4
   realtime_start realtime_end date       value
   &lt;chr&gt;          &lt;chr&gt;        &lt;chr&gt;      &lt;chr&gt;
 1 2023-04-11     2023-04-11   2010-01-01 9.8  
 2 2023-04-11     2023-04-11   2010-02-01 9.8  
 3 2023-04-11     2023-04-11   2010-03-01 9.9  
 4 2023-04-11     2023-04-11   2010-04-01 9.9  
 5 2023-04-11     2023-04-11   2010-05-01 9.6  
 6 2023-04-11     2023-04-11   2010-06-01 9.4  
 7 2023-04-11     2023-04-11   2010-07-01 9.4  
 8 2023-04-11     2023-04-11   2010-08-01 9.5  
 9 2023-04-11     2023-04-11   2010-09-01 9.5  
10 2023-04-11     2023-04-11   2010-10-01 9.4  
# ... with 149 more rows</code></pre>
</div>
</div>
<p>We could make our function more general by allowing more parameters to vary. For example, we could have a different time span for each series (the <code>obs_start</code> object). The procedure would be almost the same: we would add an extra parameter in the function, create two vectors (lists) with the parameters values and use <code>map2</code> instead of <code>map</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb119"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb119-1"><a href="#cb119-1" aria-hidden="true" tabindex="-1"></a>get_series2par <span class="ot">&lt;-</span> <span class="cf">function</span>(series_id, series_start){</span>
<span id="cb119-2"><a href="#cb119-2" aria-hidden="true" tabindex="-1"></a>  api_url       <span class="ot">&lt;-</span> <span class="st">'https://api.stlouisfed.org/fred/series/observations?'</span></span>
<span id="cb119-3"><a href="#cb119-3" aria-hidden="true" tabindex="-1"></a>  api_key       <span class="ot">&lt;-</span> api_fred_key</span>
<span id="cb119-4"><a href="#cb119-4" aria-hidden="true" tabindex="-1"></a>  api_series_id <span class="ot">&lt;-</span> series_id</span>
<span id="cb119-5"><a href="#cb119-5" aria-hidden="true" tabindex="-1"></a>  obs_start     <span class="ot">&lt;-</span> series_start</span>
<span id="cb119-6"><a href="#cb119-6" aria-hidden="true" tabindex="-1"></a>  api_filetype  <span class="ot">&lt;-</span> <span class="st">'json'</span></span>
<span id="cb119-7"><a href="#cb119-7" aria-hidden="true" tabindex="-1"></a>  api_request   <span class="ot">&lt;-</span> glue<span class="sc">::</span><span class="fu">glue</span>(<span class="st">'{api_url}series_id={api_series_id}&amp;observation_start={obs_start}&amp;api_key={api_key}&amp;file_type={api_filetype}'</span>)</span>
<span id="cb119-8"><a href="#cb119-8" aria-hidden="true" tabindex="-1"></a>  cpi_request   <span class="ot">&lt;-</span> httr<span class="sc">::</span><span class="fu">GET</span>(<span class="at">url =</span> api_request)</span>
<span id="cb119-9"><a href="#cb119-9" aria-hidden="true" tabindex="-1"></a>  cpi_content   <span class="ot">&lt;-</span> httr<span class="sc">::</span><span class="fu">content</span>(cpi_request, <span class="at">as =</span> <span class="st">'text'</span>)</span>
<span id="cb119-10"><a href="#cb119-10" aria-hidden="true" tabindex="-1"></a>  cpi_list      <span class="ot">&lt;-</span> jsonlite<span class="sc">::</span><span class="fu">fromJSON</span>(cpi_content, <span class="at">flatten =</span> <span class="cn">FALSE</span>)</span>
<span id="cb119-11"><a href="#cb119-11" aria-hidden="true" tabindex="-1"></a>  cpi_tbl       <span class="ot">&lt;-</span> cpi_list[[<span class="st">'observations'</span>]] <span class="sc">%&gt;%</span> tibble<span class="sc">::</span><span class="fu">as_tibble</span>()</span>
<span id="cb119-12"><a href="#cb119-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(cpi_tbl)</span>
<span id="cb119-13"><a href="#cb119-13" aria-hidden="true" tabindex="-1"></a>} </span>
<span id="cb119-14"><a href="#cb119-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-15"><a href="#cb119-15" aria-hidden="true" tabindex="-1"></a>time_list <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb119-16"><a href="#cb119-16" aria-hidden="true" tabindex="-1"></a>  <span class="st">'CPI'</span>   <span class="ot">=</span> <span class="st">'2010-01-01'</span>,</span>
<span id="cb119-17"><a href="#cb119-17" aria-hidden="true" tabindex="-1"></a>  <span class="st">'GDP'</span>   <span class="ot">=</span> <span class="st">'2012-04-01'</span>,</span>
<span id="cb119-18"><a href="#cb119-18" aria-hidden="true" tabindex="-1"></a>  <span class="st">'Unemp'</span> <span class="ot">=</span> <span class="st">'2014-06-01'</span></span>
<span id="cb119-19"><a href="#cb119-19" aria-hidden="true" tabindex="-1"></a>  )  </span>
<span id="cb119-20"><a href="#cb119-20" aria-hidden="true" tabindex="-1"></a>fred_data2 <span class="ot">&lt;-</span> purrr<span class="sc">::</span><span class="fu">map2</span>(<span class="at">.x =</span> id_list, <span class="at">.y =</span> time_list, <span class="at">.f =</span> get_series2par)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We must be careful with the example above because it may give the impression that <code>map2</code> takes into account the variables names in the process. It doesn’t! It actually considers how elements are sorted in each list. So if we changed the CPI to the second position in <code>time_list</code>, then we would end up with GDP data with CPI time span.</p>
<p>A safer, thus preferable, alternative is to use names rather than positions as indexes. Since we can use <code>list[['element_name']]</code> to access an element in a list, we may reduce our problem to a single dimension by looping over variables names which are the same in both lists.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb120"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb120-1"><a href="#cb120-1" aria-hidden="true" tabindex="-1"></a>vars_fred <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">'CPI'</span>, <span class="st">'GDP'</span>, <span class="st">'Unemp'</span>)</span>
<span id="cb120-2"><a href="#cb120-2" aria-hidden="true" tabindex="-1"></a>fred_data2_names <span class="ot">&lt;-</span> <span class="fu">map</span>(</span>
<span id="cb120-3"><a href="#cb120-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">.x =</span> vars_fred, </span>
<span id="cb120-4"><a href="#cb120-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">.f =</span> <span class="cf">function</span>(x) <span class="fu">get_series2par</span>(<span class="at">series_id =</span> id_list[[x]],</span>
<span id="cb120-5"><a href="#cb120-5" aria-hidden="true" tabindex="-1"></a>                               <span class="at">series_start =</span> time_list[[x]]</span>
<span id="cb120-6"><a href="#cb120-6" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb120-7"><a href="#cb120-7" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span> </span>
<span id="cb120-8"><a href="#cb120-8" aria-hidden="true" tabindex="-1"></a>  magrittr<span class="sc">::</span><span class="fu">set_names</span>(vars_fred)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Notice how powerful this solution is: you can generalize it to as many parameters as you need without taking the risk of using the parameter value of one series into another, with the additional work being only to make explicit the parameters of the function in <code>.f</code>.</p>
<p>To finish this topic, let’s get back to the end of subsection on data layout. There, we had an overview of nested data frames and I stated that I find them most useful when we need to perform several tasks over whole data sets. Also, remember that nesting a data frame is, roughly speaking, converting every cell from a single observation into a list.</p>
<p>Let’s print again the nested data frame we created up there, named <code>covid_eu_nest</code>.</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 51 x 2
# Groups:   location [51]
   location               data               
   &lt;chr&gt;                  &lt;list&gt;             
 1 Albania                &lt;tibble [665 x 66]&gt;
 2 Andorra                &lt;tibble [659 x 66]&gt;
 3 Austria                &lt;tibble [665 x 66]&gt;
 4 Belarus                &lt;tibble [662 x 66]&gt;
 5 Belgium                &lt;tibble [686 x 66]&gt;
 6 Bosnia and Herzegovina &lt;tibble [656 x 66]&gt;
 7 Bulgaria               &lt;tibble [653 x 66]&gt;
 8 Croatia                &lt;tibble [665 x 66]&gt;
 9 Cyprus                 &lt;tibble [653 x 66]&gt;
10 Czechia                &lt;tibble [663 x 66]&gt;
# ... with 41 more rows</code></pre>
</div>
</div>
<p>We can use <code>map</code> to perform computations for every country at once. Moreover, we can create new columns to store the results, thus gathering all the information in the same object.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb122"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb122-1"><a href="#cb122-1" aria-hidden="true" tabindex="-1"></a>covid_eu_nest <span class="sc">%&gt;%</span> </span>
<span id="cb122-2"><a href="#cb122-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb122-3"><a href="#cb122-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">max_total_cases =</span> <span class="fu">map_dbl</span>(</span>
<span id="cb122-4"><a href="#cb122-4" aria-hidden="true" tabindex="-1"></a>      <span class="at">.x =</span> data, </span>
<span id="cb122-5"><a href="#cb122-5" aria-hidden="true" tabindex="-1"></a>      <span class="at">.f =</span> <span class="cf">function</span>(x){</span>
<span id="cb122-6"><a href="#cb122-6" aria-hidden="true" tabindex="-1"></a>        x <span class="sc">%&gt;%</span> </span>
<span id="cb122-7"><a href="#cb122-7" aria-hidden="true" tabindex="-1"></a>          <span class="fu">pull</span>(total_cases) <span class="sc">%&gt;%</span> </span>
<span id="cb122-8"><a href="#cb122-8" aria-hidden="true" tabindex="-1"></a>          <span class="fu">max</span>(<span class="at">na.rm =</span> <span class="cn">TRUE</span>)}</span>
<span id="cb122-9"><a href="#cb122-9" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb122-10"><a href="#cb122-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">min_total_cases =</span> <span class="fu">map_dbl</span>(</span>
<span id="cb122-11"><a href="#cb122-11" aria-hidden="true" tabindex="-1"></a>      <span class="at">.x =</span> data, </span>
<span id="cb122-12"><a href="#cb122-12" aria-hidden="true" tabindex="-1"></a>      <span class="at">.f =</span> <span class="cf">function</span>(x){</span>
<span id="cb122-13"><a href="#cb122-13" aria-hidden="true" tabindex="-1"></a>        x <span class="sc">%&gt;%</span> </span>
<span id="cb122-14"><a href="#cb122-14" aria-hidden="true" tabindex="-1"></a>          <span class="fu">pull</span>(total_cases) <span class="sc">%&gt;%</span> </span>
<span id="cb122-15"><a href="#cb122-15" aria-hidden="true" tabindex="-1"></a>          <span class="fu">min</span>(<span class="at">na.rm =</span> <span class="cn">TRUE</span>)}</span>
<span id="cb122-16"><a href="#cb122-16" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb122-17"><a href="#cb122-17" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 51 x 4
# Groups:   location [51]
   location               data                max_total_cases min_total_cases
   &lt;chr&gt;                  &lt;list&gt;                        &lt;dbl&gt;           &lt;dbl&gt;
 1 Albania                &lt;tibble [665 x 66]&gt;          205897               2
 2 Andorra                &lt;tibble [659 x 66]&gt;           21062               1
 3 Austria                &lt;tibble [665 x 66]&gt;         1251433               2
 4 Belarus                &lt;tibble [662 x 66]&gt;          685462               1
 5 Belgium                &lt;tibble [686 x 66]&gt;         2017154               1
 6 Bosnia and Herzegovina &lt;tibble [656 x 66]&gt;          285133               2
 7 Bulgaria               &lt;tibble [653 x 66]&gt;          726794               4
 8 Croatia                &lt;tibble [665 x 66]&gt;          675730               1
 9 Cyprus                 &lt;tibble [653 x 66]&gt;          145996               2
10 Czechia                &lt;tibble [663 x 66]&gt;         2406989               3
# ... with 41 more rows</code></pre>
</div>
</div>
<p>And since each cell is a list rather than an observation, we’re by no means restricted to numeric elements. We could use the same strategy to create a column with plots, for example. Plotting is, by the way, the subject of the next section.</p>
</section>
<section id="plotting" class="level2" data-number="1.5">
<h2 data-number="1.5" class="anchored" data-anchor-id="plotting"><span class="header-section-number">1.5</span> Plotting</h2>
<p>We’re almost there in our goal to review the basics of Tidyverse. Succinctly describing all the previous sections was challenging, but I believe you had enough information to start carrying out data analyzes on your own. When it comes to making graphics, extrapolating from the basics is somewhat harder because there are infinite possibilities for customization.</p>
<p>In fact, the grammar used in <code>ggplot2</code> package is broad and far from simple at first glance. But as you practice, it becomes increasingly graspable. Still, I encourage you to dive into the amazing <span class="citation" data-cites="ggplo2book">Wickham, Navarro, and Pedersen (<a href="#ref-ggplo2book" role="doc-biblioref">2019</a>)</span> since getting fluent on this subject is indispensable.</p>
<p>Let’s think about the process of making a graphic as a set of layers arranged sequentially. The first layer is the data you want to plot. We’ll use the CPI data from the Importing section. The second layer is the <code>ggplot</code> function. So far, there’s nothing to visualize. All these two layers do is to set the stage for what’s coming next.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb124"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb124-1"><a href="#cb124-1" aria-hidden="true" tabindex="-1"></a>cpi_tbl <span class="sc">%&gt;%</span> </span>
<span id="cb124-2"><a href="#cb124-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The third layer we must provide is the <code>geom</code>, which is the geometry used to represent our data. This is the most important layer as it contains a set of parameters that effectively creates a visualization of the data. For time series data we generally use a line graph, so <code>geom_line</code> is the appropriate geometry. In addition, we need to provide the values for <code>x</code> and <code>y</code> axes. In this case, they’re the dates and CPI values, respectively.</p>
<p>Before proceeding, we need to make sure that the values for <code>x</code> and <code>y</code> are in the appropriate class. We can use the <code>glimpse</code> function from <code>dplyr</code> package to check this out.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb125"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb125-1"><a href="#cb125-1" aria-hidden="true" tabindex="-1"></a>cpi_tbl <span class="sc">%&gt;%</span></span>
<span id="cb125-2"><a href="#cb125-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">glimpse</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 156
Columns: 4
$ realtime_start &lt;chr&gt; "2023-04-11", "2023-04-11", "2023-04-11", "2023-04-11",~
$ realtime_end   &lt;chr&gt; "2023-04-11", "2023-04-11", "2023-04-11", "2023-04-11",~
$ date           &lt;chr&gt; "2010-01-01", "2010-02-01", "2010-03-01", "2010-04-01",~
$ value          &lt;chr&gt; "0.34174735701485", "0.024920738207648", "0.41062835365~</code></pre>
</div>
</div>
<p>We see that both <code>date</code> and <code>value</code> (the CPI value) are in character format and so we need to convert them to date and numeric format, respectively. One last thing we need to be aware of is that <code>ggplot</code> uses <code>+</code> instead of <code>%&gt;%</code> as an operator to chain actions. Therefore, every layer we add is preceded by a <code>+</code>. The code below produces the simplest plot from CPI data.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb127"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb127-1"><a href="#cb127-1" aria-hidden="true" tabindex="-1"></a>cpi_tbl <span class="sc">%&gt;%</span></span>
<span id="cb127-2"><a href="#cb127-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb127-3"><a href="#cb127-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">date  =</span> <span class="fu">ymd</span>(date),</span>
<span id="cb127-4"><a href="#cb127-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">value =</span> <span class="fu">as.numeric</span>(value)</span>
<span id="cb127-5"><a href="#cb127-5" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb127-6"><a href="#cb127-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span> </span>
<span id="cb127-7"><a href="#cb127-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">y =</span> value))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="ds_tidyverse_files/figure-html/unnamed-chunk-64-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>What should we care about this plot? Well, every plot must contain a meaningful title and labels for both x and y axes. We can set them using the <code>labs</code> layer. Additionally, we might want to have shorter intervals for dates (x-axis) and values (y-axis). There are also specific layers to control axes settings.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb128"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb128-1"><a href="#cb128-1" aria-hidden="true" tabindex="-1"></a>cpi_tbl <span class="sc">%&gt;%</span></span>
<span id="cb128-2"><a href="#cb128-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb128-3"><a href="#cb128-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">date =</span> <span class="fu">ymd</span>(date),</span>
<span id="cb128-4"><a href="#cb128-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">value =</span> <span class="fu">as.numeric</span>(value)</span>
<span id="cb128-5"><a href="#cb128-5" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb128-6"><a href="#cb128-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span> </span>
<span id="cb128-7"><a href="#cb128-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">y =</span> value)) <span class="sc">+</span></span>
<span id="cb128-8"><a href="#cb128-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb128-9"><a href="#cb128-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">'US CPI showing an upward trend as of 2021'</span>,</span>
<span id="cb128-10"><a href="#cb128-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">x     =</span> <span class="st">'Date'</span>,</span>
<span id="cb128-11"><a href="#cb128-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">y     =</span> <span class="st">'US Monthly CPI (%)'</span></span>
<span id="cb128-12"><a href="#cb128-12" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb128-13"><a href="#cb128-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_date</span>(<span class="at">date_breaks =</span> <span class="st">'1 year'</span>, <span class="at">date_labels =</span> <span class="st">'%Y'</span>) <span class="sc">+</span></span>
<span id="cb128-14"><a href="#cb128-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">breaks =</span> <span class="fu">seq</span>(<span class="sc">-</span><span class="dv">1</span>, <span class="fl">1.5</span>, <span class="fl">0.25</span>), <span class="at">limits =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>,<span class="fl">1.5</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="ds_tidyverse_files/figure-html/unnamed-chunk-65-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Finally, we could be interested in adding some feature to the plot in order to highlight the upward trend in CPI as of 2021. Either the 12-month-accumulated CPI or the 3-months-accumulated seasonally-adjusted CPI would be common choices for this task and we’ll see examples of how to perform this kind of computation later. For now, just to keep things simple we’ll use the average CPI from 2010 to 2019 (the pre-COVID period) as a measure of ‘normal’ CPI.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb129"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb129-1"><a href="#cb129-1" aria-hidden="true" tabindex="-1"></a>cpi_tbl <span class="sc">%&gt;%</span></span>
<span id="cb129-2"><a href="#cb129-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb129-3"><a href="#cb129-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">date =</span> <span class="fu">ymd</span>(date),</span>
<span id="cb129-4"><a href="#cb129-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">value =</span> <span class="fu">as.numeric</span>(value)</span>
<span id="cb129-5"><a href="#cb129-5" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb129-6"><a href="#cb129-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">value_avg =</span> <span class="fu">mean</span>(value[<span class="fu">which</span>(<span class="fu">year</span>(date) <span class="sc">%in%</span> <span class="dv">2010</span><span class="sc">:</span><span class="dv">2019</span>)])) <span class="sc">%&gt;%</span> </span>
<span id="cb129-7"><a href="#cb129-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span> </span>
<span id="cb129-8"><a href="#cb129-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">y =</span> value)) <span class="sc">+</span></span>
<span id="cb129-9"><a href="#cb129-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">y =</span> value_avg), <span class="at">color =</span> <span class="st">'red'</span>, <span class="at">lwd =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb129-10"><a href="#cb129-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb129-11"><a href="#cb129-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">title    =</span> <span class="st">'US CPI showing an upward trend as of 2021'</span>,</span>
<span id="cb129-12"><a href="#cb129-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">'Red line is the 2010-2019 average'</span>,</span>
<span id="cb129-13"><a href="#cb129-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">x        =</span> <span class="st">'Date'</span>,</span>
<span id="cb129-14"><a href="#cb129-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">y        =</span> <span class="st">'US Monthly CPI (%)'</span></span>
<span id="cb129-15"><a href="#cb129-15" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb129-16"><a href="#cb129-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_date</span>(<span class="at">date_breaks =</span> <span class="st">'1 year'</span>, <span class="at">date_labels =</span> <span class="st">'%Y'</span>) <span class="sc">+</span></span>
<span id="cb129-17"><a href="#cb129-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">breaks =</span> <span class="fu">seq</span>(<span class="sc">-</span><span class="dv">1</span>, <span class="dv">1</span>, <span class="fl">0.25</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="ds_tidyverse_files/figure-html/unnamed-chunk-66-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Since the parameter <code>x = date</code> appears in both <code>geom_line</code> layers, we could make the code more compact by moving this parameter to <code>ggplot()</code> function. All the parameters inside <code>ggplot()</code> are carried forward to every subsequent layer. It saves a lot of effort when we’re adding <code>geom_*</code>’s to a graphic with fixed features. In this graphic, <code>x</code> will always be the date variable regardless of any layer I insert on it.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb130"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb130-1"><a href="#cb130-1" aria-hidden="true" tabindex="-1"></a>cpi_tbl <span class="sc">%&gt;%</span></span>
<span id="cb130-2"><a href="#cb130-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb130-3"><a href="#cb130-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">date =</span> <span class="fu">ymd</span>(date),</span>
<span id="cb130-4"><a href="#cb130-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">value =</span> <span class="fu">as.numeric</span>(value)</span>
<span id="cb130-5"><a href="#cb130-5" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb130-6"><a href="#cb130-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">value_avg =</span> <span class="fu">mean</span>(value[<span class="fu">which</span>(<span class="fu">year</span>(date) <span class="sc">%in%</span> <span class="dv">2010</span><span class="sc">:</span><span class="dv">2019</span>)])) <span class="sc">%&gt;%</span> </span>
<span id="cb130-7"><a href="#cb130-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> date)) <span class="sc">+</span> </span>
<span id="cb130-8"><a href="#cb130-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> value)) <span class="sc">+</span></span>
<span id="cb130-9"><a href="#cb130-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> value_avg), <span class="at">color =</span> <span class="st">'red'</span>, <span class="at">lwd =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb130-10"><a href="#cb130-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb130-11"><a href="#cb130-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">title    =</span> <span class="st">'US CPI showing an upward trend as of 2021'</span>,</span>
<span id="cb130-12"><a href="#cb130-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">'Red line is the 2010-2019 average'</span>,</span>
<span id="cb130-13"><a href="#cb130-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">x        =</span> <span class="st">'Date'</span>,</span>
<span id="cb130-14"><a href="#cb130-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">y        =</span> <span class="st">'US Monthly CPI (%)'</span></span>
<span id="cb130-15"><a href="#cb130-15" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb130-16"><a href="#cb130-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_date</span>(<span class="at">date_breaks =</span> <span class="st">'1 year'</span>, <span class="at">date_labels =</span> <span class="st">'%Y'</span>) <span class="sc">+</span></span>
<span id="cb130-17"><a href="#cb130-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">breaks =</span> <span class="fu">seq</span>(<span class="sc">-</span><span class="dv">1</span>, <span class="fl">1.5</span>, <span class="fl">0.25</span>), <span class="at">limits =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>, <span class="fl">1.5</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>You should be asking yourself why <code>x</code> and <code>y</code> parameters went inside the <code>aes</code> function whereas <code>color</code> went outside it. First of all, the parameters which set the graphic axes always go inside <code>aes</code>. Other parameters have a special role whether they appear inside or outside <code>aes</code>. According to the documentation, <em>aesthetic mappings describe how variables in the data are mapped to visual properties (aesthetics) of geoms</em>. It’s much easier to understand through an example.</p>
<p>In the graphic above, we used <code>color</code> outside <code>aes</code> to define which color we wanted for the graphic line. However, if we were to use <code>color</code> as an attribute to highlight different groups from the data, <code>color</code> should go inside <code>aes</code>. In addition, we should pass a variable onto it instead of color names. This variable might be discrete, in which case we would have one color per group; or it might be continuous, in which case we would have a color gradient according to its magnitude.</p>
<p>In the piece of code below we create a new variable named <code>covid_period</code> to separate the CPI data between pre-Covid and Covid periods and use it as a color attribute.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb131"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb131-1"><a href="#cb131-1" aria-hidden="true" tabindex="-1"></a>cpi_tbl <span class="sc">%&gt;%</span></span>
<span id="cb131-2"><a href="#cb131-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb131-3"><a href="#cb131-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">date  =</span> <span class="fu">ymd</span>(date),</span>
<span id="cb131-4"><a href="#cb131-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">value =</span> <span class="fu">as.numeric</span>(value),</span>
<span id="cb131-5"><a href="#cb131-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">covid =</span> <span class="fu">if_else</span>(<span class="fu">between</span>(date, <span class="fu">ymd</span>(<span class="st">'2020-03-01'</span>), <span class="fu">ymd</span>(<span class="st">'2022-12-01'</span>)), <span class="st">'Yes'</span>, <span class="st">'No'</span>)</span>
<span id="cb131-6"><a href="#cb131-6" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb131-7"><a href="#cb131-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span> </span>
<span id="cb131-8"><a href="#cb131-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">y =</span> value, <span class="at">color =</span> covid), <span class="at">lwd =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb131-9"><a href="#cb131-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb131-10"><a href="#cb131-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">title    =</span> <span class="st">'US CPI showing an upward trend as of 2021'</span>,</span>
<span id="cb131-11"><a href="#cb131-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">x        =</span> <span class="st">'Date'</span>,</span>
<span id="cb131-12"><a href="#cb131-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">y        =</span> <span class="st">'US Monthly CPI (%)'</span></span>
<span id="cb131-13"><a href="#cb131-13" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb131-14"><a href="#cb131-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_date</span>(<span class="at">date_breaks =</span> <span class="st">'1 year'</span>, <span class="at">date_labels =</span> <span class="st">'%Y'</span>) <span class="sc">+</span></span>
<span id="cb131-15"><a href="#cb131-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">breaks =</span> <span class="fu">seq</span>(<span class="sc">-</span><span class="dv">1</span>, <span class="fl">1.5</span>, <span class="fl">0.25</span>), <span class="at">limits =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>, <span class="fl">1.5</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="ds_tidyverse_files/figure-html/unnamed-chunk-68-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Note that <code>ggplot</code> automatically assigns colors for the attributes and adds a legend. So we could be interested in customize both the attributes’ colors and legend position. Again, this might be achieved by adding two specific layers. The logic will always be the same: <strong>parameters inside <code>aes</code> turn a variable into an attribute which might then be customized by specific layers</strong>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb132"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb132-1"><a href="#cb132-1" aria-hidden="true" tabindex="-1"></a>cpi_tbl <span class="sc">%&gt;%</span></span>
<span id="cb132-2"><a href="#cb132-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb132-3"><a href="#cb132-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">date  =</span> <span class="fu">ymd</span>(date),</span>
<span id="cb132-4"><a href="#cb132-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">value =</span> <span class="fu">as.numeric</span>(value),</span>
<span id="cb132-5"><a href="#cb132-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">covid =</span> <span class="fu">if_else</span>(<span class="fu">between</span>(date, <span class="fu">ymd</span>(<span class="st">'2020-03-01'</span>), <span class="fu">ymd</span>(<span class="st">'2022-12-01'</span>)), <span class="st">'Yes'</span>, <span class="st">'No'</span>)</span>
<span id="cb132-6"><a href="#cb132-6" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb132-7"><a href="#cb132-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span> </span>
<span id="cb132-8"><a href="#cb132-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">y =</span> value, <span class="at">color =</span> covid), <span class="at">lwd =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb132-9"><a href="#cb132-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb132-10"><a href="#cb132-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">title    =</span> <span class="st">'US CPI showing an upward trend as of 2021'</span>,</span>
<span id="cb132-11"><a href="#cb132-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">x        =</span> <span class="st">'Date'</span>,</span>
<span id="cb132-12"><a href="#cb132-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">y        =</span> <span class="st">'US Monthly CPI (%)'</span>) <span class="sc">+</span></span>
<span id="cb132-13"><a href="#cb132-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_date</span>(<span class="at">date_breaks =</span> <span class="st">'1 year'</span>, <span class="at">date_labels =</span> <span class="st">'%Y'</span>) <span class="sc">+</span></span>
<span id="cb132-14"><a href="#cb132-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">breaks =</span> <span class="fu">seq</span>(<span class="sc">-</span><span class="dv">1</span>, <span class="fl">1.5</span>, <span class="fl">0.25</span>), <span class="at">limits =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>, <span class="fl">1.5</span>)) <span class="sc">+</span></span>
<span id="cb132-15"><a href="#cb132-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">'darkgreen'</span>, <span class="st">'orange'</span>)) <span class="sc">+</span></span>
<span id="cb132-16"><a href="#cb132-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">'top'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="ds_tidyverse_files/figure-html/unnamed-chunk-69-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>As a final example, we’ll see how to build a scatter plot and explore some additional features from <code>ggplot</code>. Scatter plots are usually employed to highlight the relationship between two variables in a given point in time. For this task, let’s use again the Covid data set. We’ll first filter the data to a given point in time, say 2021-07-31. Next, we’ll plot <code>people_fully_vaccinated_per_hundred</code> and <code>new_deaths_smoothed_per_million</code> on the <code>x</code> and <code>y</code> axes, respectively.<a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb133"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb133-1"><a href="#cb133-1" aria-hidden="true" tabindex="-1"></a>covid_data <span class="sc">%&gt;%</span> </span>
<span id="cb133-2"><a href="#cb133-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(date <span class="sc">==</span> <span class="st">'2021-07-31'</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb133-3"><a href="#cb133-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb133-4"><a href="#cb133-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(</span>
<span id="cb133-5"><a href="#cb133-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(</span>
<span id="cb133-6"><a href="#cb133-6" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> people_fully_vaccinated_per_hundred,</span>
<span id="cb133-7"><a href="#cb133-7" aria-hidden="true" tabindex="-1"></a>      <span class="at">y =</span> new_deaths_smoothed_per_million</span>
<span id="cb133-8"><a href="#cb133-8" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb133-9"><a href="#cb133-9" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 133 rows containing missing values (geom_point).</code></pre>
</div>
<div class="cell-output-display">
<p><img src="ds_tidyverse_files/figure-html/unnamed-chunk-70-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>We saw earlier how to manually set the color to each group. It’s worth emphasizing that we’re by no means bounded to using colors names as <code>ggplot</code> also works with other tools such as HEX codes and the awesome ColorBrewer. ColorBrewer is an amazing source for color schemes carefully designed to improve visual communication. You can check this out at https://colorbrewer2.org/.</p>
<p>We’ll stick with ColorBrewer since it makes it effortless to assign a different color to each of the six continents. Notice that after choosing your desired pattern and palette in the website, you get some meta data (type and scheme) that will be used here.</p>
<p>In addition, we’ll use <code>theme_light()</code> to make our plot cleaner. Basically, a theme is a set of pre-defined features for a graph. You can check other built-in themes, including <code>theme_dark()</code>, <code>theme_minimal()</code>, <code>theme_classic()</code> and so on.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb135"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb135-1"><a href="#cb135-1" aria-hidden="true" tabindex="-1"></a>covid_data <span class="sc">%&gt;%</span> </span>
<span id="cb135-2"><a href="#cb135-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(</span>
<span id="cb135-3"><a href="#cb135-3" aria-hidden="true" tabindex="-1"></a>    date <span class="sc">==</span> <span class="st">'2021-07-31'</span>,</span>
<span id="cb135-4"><a href="#cb135-4" aria-hidden="true" tabindex="-1"></a>    <span class="sc">!</span><span class="fu">is.na</span>(continent)</span>
<span id="cb135-5"><a href="#cb135-5" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb135-6"><a href="#cb135-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb135-7"><a href="#cb135-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(</span>
<span id="cb135-8"><a href="#cb135-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(</span>
<span id="cb135-9"><a href="#cb135-9" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> people_fully_vaccinated_per_hundred,</span>
<span id="cb135-10"><a href="#cb135-10" aria-hidden="true" tabindex="-1"></a>      <span class="at">y =</span> new_deaths_smoothed_per_million,</span>
<span id="cb135-11"><a href="#cb135-11" aria-hidden="true" tabindex="-1"></a>      <span class="at">color =</span> continent</span>
<span id="cb135-12"><a href="#cb135-12" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb135-13"><a href="#cb135-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">size =</span> <span class="dv">3</span></span>
<span id="cb135-14"><a href="#cb135-14" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb135-15"><a href="#cb135-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">'New deaths in late July were above 5 per million people in countries where </span><span class="sc">\n</span><span class="st"> vaccination falls below 30% of population'</span>) <span class="sc">+</span></span>
<span id="cb135-16"><a href="#cb135-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_brewer</span>(<span class="at">type =</span> <span class="st">'qual'</span>, <span class="at">palette =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb135-17"><a href="#cb135-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_light</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 133 rows containing missing values (geom_point).</code></pre>
</div>
<div class="cell-output-display">
<p><img src="ds_tidyverse_files/figure-html/unnamed-chunk-71-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>To finish, instead of showing all the continents in a single plot we could separate them in multiple panels using <code>facet_wrap</code>. This feature is very useful when the range of values across the groups differ greatly in magnitude.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb137"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb137-1"><a href="#cb137-1" aria-hidden="true" tabindex="-1"></a>covid_data <span class="sc">%&gt;%</span> </span>
<span id="cb137-2"><a href="#cb137-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(</span>
<span id="cb137-3"><a href="#cb137-3" aria-hidden="true" tabindex="-1"></a>    date <span class="sc">==</span> <span class="st">'2021-07-31'</span>,</span>
<span id="cb137-4"><a href="#cb137-4" aria-hidden="true" tabindex="-1"></a>    <span class="sc">!</span><span class="fu">is.na</span>(continent)</span>
<span id="cb137-5"><a href="#cb137-5" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb137-6"><a href="#cb137-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb137-7"><a href="#cb137-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(</span>
<span id="cb137-8"><a href="#cb137-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(</span>
<span id="cb137-9"><a href="#cb137-9" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> people_fully_vaccinated_per_hundred,</span>
<span id="cb137-10"><a href="#cb137-10" aria-hidden="true" tabindex="-1"></a>      <span class="at">y =</span> new_deaths_smoothed_per_million</span>
<span id="cb137-11"><a href="#cb137-11" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb137-12"><a href="#cb137-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">size =</span> <span class="dv">3</span></span>
<span id="cb137-13"><a href="#cb137-13" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb137-14"><a href="#cb137-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb137-15"><a href="#cb137-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">'New deaths in late July were above 5 per million people in countries where </span><span class="sc">\n</span><span class="st"> vaccination falls below 30% of population'</span></span>
<span id="cb137-16"><a href="#cb137-16" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb137-17"><a href="#cb137-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_light</span>() <span class="sc">+</span></span>
<span id="cb137-18"><a href="#cb137-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> continent)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="ds_tidyverse_files/figure-html/unnamed-chunk-72-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Since we have a separate panel for each continent, it’s no longer necessary to assign a different color for each of them. As you go through the next Chapters, you’ll see more plotting features and tips on how to improve data visualization.</p>


<div id="refs" class="references csl-bib-body hanging-indent" role="doc-bibliography">
<div id="ref-r4ds" class="csl-entry" role="doc-biblioentry">
Grolemund, G., and H. Wickham. 2017. <em>R for Data Science, 1st Edition</em>. O’Reilly Media.
</div>
<div id="ref-ggplo2book" class="csl-entry" role="doc-biblioentry">
Wickham, H., Danielle Navarro, and Thomas Lin Pedersen. 2019. <em>Ggplot2: Elegant Graphics for Data Analysis, 3rd Edition</em>. Springer.
</div>
</div>
</section>
<section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes">
<hr>
<ol>
<li id="fn1"><p>Actually, these information are contained in the <code>covid_data</code> object, but let’s pretend it’s not.<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2"><p>Another case for the <code>by</code> argument is when we have more than one column with the same name across the data sets, but we don’t want to use them all as keys.<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn3"><p>Be aware that we’re not trying to establish a causal relationship, nor to find a threshold for vaccination above which people are safe. We must be careful when interpreting this graphic, since omitted variables such as age and previous exposure to the virus may influence the outcome.<a href="#fnref3" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    setTimeout(function() {
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const cites = ref.parentNode.getAttribute('data-cites').split(' ');
    tippyHover(ref, function() {
      var popup = window.document.createElement('div');
      cites.forEach(function(cite) {
        var citeDiv = window.document.createElement('div');
        citeDiv.classList.add('hanging-indent');
        citeDiv.classList.add('csl-entry');
        var biblioDiv = window.document.getElementById('ref-' + cite);
        if (biblioDiv) {
          citeDiv.innerHTML = biblioDiv.innerHTML;
        }
        popup.appendChild(citeDiv);
      });
      return popup.innerHTML;
    });
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./index.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text">Preface</span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./ds_googlemob.html" class="pagination-link">
        <span class="nav-page-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Scaling-up tasks</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->



</body></html>